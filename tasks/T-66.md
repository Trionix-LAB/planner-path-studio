# T-66: fix(mission): autosave/sync/draft data loss — consolidate duplicates

**Issue:** #66 https://github.com/Trionix-LAB/planner-path-studio/issues/66
**Spec:** `spec/spec.md` (R-013, R-016, R-026) + on-disk format `docs/mission-format.md`

## Context / Findings
- Draft mode is rooted at `draft/current` (see `DRAFT_ROOT_PATH` in `src/pages/MapWorkspace.tsx`). Start screen considers draft recoverable if `draft/current/mission.json` exists (`src/pages/StartScreen.tsx`).
- Autosave logic exists in `src/pages/MapWorkspace.tsx` (see `autosaveTimerRef`). There are draft session tests in `src/test/draftSession.test.ts`.
- Draft -> Mission conversion currently creates a new mission via `repository.createMission(...)` without migrating draft contents (see `handleCreateMission` in `src/pages/MapWorkspace.tsx`). This is called out as a spec mismatch in `spec/implementation-audit.md` (R-013/R-020).
- `missionsDir` is persisted under settings key `planner.missionsDir`:
  - StartScreen reads/writes it explicitly (`src/pages/StartScreen.tsx`).
  - Platform exposes `platform.paths.defaultMissionsDir()` backed by the same remembered path (`src/platform/web/platform.ts`, `src/platform/electron/platform.ts`).
  - Dialogs `src/components/dialogs/CreateMissionDialog.tsx` and `src/components/dialogs/OpenMissionDialog.tsx` initialize from `defaultMissionsDir()` but do not persist updates when user picks a directory (likely causing inconsistencies noted in issue).

## Goal
- Убрать риск потери данных в потоках: draft → mission, закрытие приложения во время активной миссии, выбор/синхронизация папки миссий.
- Свести дублирующиеся источники правды (особенно для `missionsDir`) к одному детерминированному поведению.

## Acceptance (DoD)
- [x] Draft → Mission conversion сохраняет данные черновика и после успешной конверсии черновик не предлагается к восстановлению как актуальный.
- [x] Закрытие приложения в активной миссии приводит к детерминированному сохранению и корректному recovery-flow на следующем старте.
- [x] `missionsDir` имеет единый source of truth (settings) для StartScreen и всех диалогов; изменения директории сразу персистятся.
- [x] Добавлены регрессионные тесты/сценарии на критичные потоки (draft convert, close/recover, missionsDir sync).

## Plan
- [x] Draft → Mission:
  - Найти точку, где пользователь в draft вызывает создание миссии (см. `handleCreateMission` в `src/pages/MapWorkspace.tsx`).
  - Реализовать миграцию содержимого `draft/current/*` в новую папку миссии в соответствии с `docs/mission-format.md`.
  - После успешной конверсии очистить draft или пометить его как «конвертированный», чтобы не появлялся recover (см. проверку `draft/current/mission.json` на старте).
- [x] Close / recovery flow:
  - Проверить, что при закрытии приложения активная миссия/треки завершаются и состояние сохраняется (ожидаемо связано с repository lock + autosave).
  - Добавить детерминированный recovery path на старте (без зависания на stale lock, без потери последних изменений).
- [x] missionsDir sync:
  - Привести `OpenMissionDialog` и `CreateMissionDialog` к тому, чтобы выбранная пользователем папка сразу сохранялась в `planner.missionsDir` (как в StartScreen) и использовалась по умолчанию везде.
- [x] Tests:
  - Расширить/добавить тесты вокруг draft session (`src/test/draftSession.test.ts`), StartScreen (`src/test/startScreen.test.tsx`), диалогов (`src/test/openMissionDialog.test.tsx`, `src/test/createMissionDialog.test.tsx`), recent missions (`src/test/useRecentMissions.test.tsx`).
- [x] Run: `npm run lint`, `npm run test`, `npm run build`.

## Execution Notes
- Реализован `repository.convertDraftToMission(...)` с переносом данных из `draft/current` в целевую папку миссии, очисткой `draft/current` после успешного сохранения и покрытием тестами.
- Для открытия миссий добавлена опция `recoverLock` в `repository.openMission(...)` и использована в `MapWorkspace` для восстановления после stale `mission.lock`.
- В `MapWorkspace` усилен close/persist flow: отмена pending autosave перед финальным snapshot, попытка снять lock на `pagehide`/`beforeunload`, восстановление из lock с `recoverLock`.
- `planner.missionsDir` вынесен в общий константный ключ (`src/features/mission/model/constants.ts`); `StartScreen`, `CreateMissionDialog`, `OpenMissionDialog` используют его как единый source of truth через `platform.settings`.
- Диалоги `Create/Open` теперь читают сохраненный `missionsDir` при открытии и персистят выбранную пользователем директорию сразу после выбора.
- Проверки:
  - `npm run test` (41 files / 165 tests) — OK
  - `npm run lint` — OK
  - `npm run build` — OK

## Codex Handoff Notes
- Primary entry points: `src/pages/MapWorkspace.tsx`, `src/pages/StartScreen.tsx`, `src/components/dialogs/CreateMissionDialog.tsx`, `src/components/dialogs/OpenMissionDialog.tsx`.
- Domain/helpers likely involved: `src/features/mission/model/*`, repository layer (search for `createMission`, `openMission`, draft paths), platform settings/paths (`src/platform/*`).
- Keep platform boundaries: filesystem/paths persistence via `platform.*`; mission format changes must follow `docs/mission-format.md`.
- Use `spec/implementation-audit.md` as a checklist for known mismatches; don’t widen scope beyond issue #66 unless it directly prevents data loss.

## Follow-up Hardening (2026-02-28)
- Added anti-TOCTOU fallback in `loadDraftSession(...)`:
  - If `draftExists()` is true but `openDraft()` fails with `Mission file not found`, the flow now recreates a fresh draft instead of surfacing intermittent warning.
- Hardened `/create-mission` and `/open-mission` init sequence in `MapWorkspace`:
  - Draft is loaded first, dialog opens only after draft hydration.
  - False-positive alert is suppressed for known transient draft-missing case on those routes.
- Hardened `handleCreateMission(...)`:
  - Before draft conversion: ensure `draft/current/mission.json` exists and persist latest snapshot.
  - Added one retry path for `convertDraftToMission` when failure matches `Mission file not found`.
- Improved dialog resilience:
  - `CreateMissionDialog` now supports async `onConfirm`, disables controls during submit, and prevents duplicate submissions.
  - `CreateMissionDialog` and `OpenMissionDialog` no longer overwrite manually edited folder input when async settings read resolves late.
- Added regression tests:
  - `src/test/draftSession.test.ts`: missing-draft TOCTOU fallback for `resume`/`recover`.
  - `src/test/createMissionDialog.test.tsx`: no late overwrite + submit lock behavior.
  - `src/test/openMissionDialog.test.tsx`: no late overwrite.
- Re-verified:
  - `npm run lint` OK
  - `npm run test` OK (41 files / 170 tests)
  - `npm run build` OK

## Follow-up Hardening (2026-02-28, pass 2)
- Mission persistence hardening in repository:
  - Added serialized `saveMission(...)` queue per mission root to avoid concurrent autosave/close write races.
  - Added dual-file metadata persistence: `mission.json` + `mission.json.bak`.
  - Added open fallback: if primary `mission.json` is empty/missing/corrupted, repository attempts `mission.json.bak` and restores primary file best-effort.
- Electron fs write hardening:
  - Switched `fileStore.writeText` to atomic write strategy (`*.tmp-*` + rename).
  - Switched settings file writes to the same atomic strategy to reduce truncation risks on abrupt termination.
- Recent missions hardening:
  - Metadata loading now falls back to `mission.json.bak` when `mission.json` is invalid.
  - Entries with invalid primary+backup metadata are skipped to prevent broken "open" targets.
- Added regression tests:
  - `src/test/missionRepository.test.ts`: open from backup when `mission.json` missing/empty.
  - `src/test/recentMissions.test.ts`: backup fallback and invalid-entry skip behavior.
- Re-verified:
  - `npm run test` OK (41 files / 174 tests)
  - `npm run lint` OK
  - `npm run build` OK
