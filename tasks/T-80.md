# T-80: Equipment supports multiple device instances per profile

**Issue:** #80
**Spec:** New requirement

## Context (current architecture)
Equipment settings are stored in a schema-driven model:
* UI: `src/pages/EquipmentScreen.tsx`
* Types: `src/features/devices/model/types.ts`
  - `EquipmentSettingsV2` uses `profiles[].device_ids: string[]`
  - `devices: Record<schemaId, DeviceConfig>` (1 config per schema id)
  - `selected_device_id` points to a schema id
* Normalization/migration/runtime: `src/features/devices/model/settings.ts`
  - `buildEquipmentRuntime()` emits a single `runtime.gnss_udp` and `runtime.zima` based on active profile membership.
* Device schemas: `src/features/devices/model/schemaLoader.ts`

Problem: by keying configs by schema id, the app cannot represent two devices of the same schema in one profile.

## Goal
* Allow multiple instances of the same device schema within one equipment profile.
* Use profile device instances as selectable navigation sources in map settings for:
  - divers;
  - base station.
* Remove manual `Сделать основным` action from equipment UI.
* Maintain backward compatibility by migrating existing V2 settings and legacy mission source ids.

## Key design decision (recommendation)
Introduce device *instances* as first-class entries.

### New settings model (proposed)
* `EquipmentSettingsV3`:
  - `schema_version: 3`
  - `selected_profile_id: string`
  - `selected_device_instance_id: string` (or nullable)
  - `profiles: Array<{ id, name, device_instance_ids: string[] }>`
  - `device_instances: Record<string, { id: string; schema_id: string; name?: string; config: DeviceConfig; is_primary?: boolean }>`

Rationale:
* Supports multiple instances per schema.
* Keeps schema-driven forms unchanged: you still render fields from `schema_id`, but bind values to instance.config.
* Migration is straightforward: for each schemaId in old profile.device_ids create one instance.

### Runtime model impact
* Runtime MAY keep internal fallback/priority resolution for bridges that still work by schema type.
* Agents/base station source assignment in map settings MUST be instance-based (instance id), not schema-based.

## Scope split note
Issue #80 mentions "refactor agents integration" too. For MVP, implement only multi-instance equipment model + runtime selection.
Refactor of agents integration should be tracked separately if still needed.

## Implementation plan (for agent)
1) Spec
* [x] Add a new requirement in `spec/spec.md` (R-0xx):
  - multiple instances per schema
  - naming/primary selection
  - migration from legacy settings

2) Types
* [x] Update `src/features/devices/model/types.ts`:
  - introduce `EquipmentSettingsV3` and `EquipmentRuntimeV3` (or keep runtime v2 but clarify).
  - define `DeviceInstance` type.

3) Settings normalization & migration
* [x] Update `src/features/devices/model/settings.ts`:
  - support reading v2 and migrating to v3
  - update storage key version if needed (or keep key but bump schema_version)
  - implement normalization for:
    - profiles.device_instance_ids (unique, existing)
    - selected_device_instance_id
    - device_instances map

4) UI updates
* [x] `src/pages/EquipmentScreen.tsx`:
  - replace schema selection (device id) with instance selection
  - allow adding/removing instances of a given schema within the selected profile
  - update form binding: `selectedSchema` is derived from selected instance.schema_id
  - update validation loop to validate every instance in active profile

5) Follow-up (scope update after review)
* [x] remove `Сделать основным` controls from `EquipmentScreen`.
* [x] map `SettingsDialog` navigation source selector to active profile instance list (with labels and schema metadata).
* [x] update `MapWorkspace` source resolution:
  - source ids in mission UI become instance ids (or `simulation`);
  - telemetry provider resolution stays schema-based (`zima2r` / `gnss-udp`) via instance->schema mapping;
  - legacy mission source values (`zima2r`, `gnss-udp`) are auto-mapped to first matching profile instance.
* [x] update docs/spec for new source semantics and removed primary button.
* [x] update tests and run full verification.
* [x] make equipment toggles independent per device instance in `Настройки -> Оборудование`.
* [x] remove technical suffixes in parentheses from source labels in `Настройки -> Агенты`.

6) Runtime
* [x] Update `buildEquipmentRuntime` to choose configs from instances, not from per-schema record.
* Ensure downstream consumers can still access runtime as before (e.g. `runtime.gnss_udp`).

7) Tests
* [x] Update/add tests:
  - `src/test/deviceSettings.test.ts`: migration v2->v3, multiple instances, primary selection
  - `src/test/equipmentScreen.test.tsx`: CRUD instances + primary toggle (smoke)

8) Verify
* [x] `npm run typecheck && npm run lint && npm run test`

## Acceptance checklist
* [x] Multiple device instances per schema can be created/edited/deleted in one profile.
* [x] Runtime selection resolves from device instances.
* [x] Legacy settings migrate without data loss.
* [x] Tests cover migration and basic UI CRUD.

## Execution log
* Updated contract:
  - added `R-053` to `spec/spec.md`,
  - aligned equipment screen description in `docs/screens.md`,
  - updated `docs/devices.md` with multi-instance + primary semantics.
* Migrated equipment domain model to V3:
  - `EquipmentSettingsV3` (`profiles[].device_instance_ids`, `device_instances`, `selected_device_instance_id`),
  - `EquipmentRuntimeV3` with instance metadata and `active_profile.device_instance_ids`,
  - backward-compatible normalization/migration from `schema_version=1/2`.
* Reworked Equipment UI (`src/pages/EquipmentScreen.tsx`):
  - add/remove device instances,
  - active instance selection,
  - config edit binds to `selectedDeviceInstance.config`.
* Removed `Сделать основным` controls from equipment screen (list and detail card).
* Updated map consumer (`src/pages/MapWorkspace.tsx`):
  - sources for divers/base station are instance-based;
  - telemetry stream remains schema-based via instance->schema resolution;
  - legacy mission values (`zima2r` / `gnss-udp`) are mapped to first matching instance.
  - equipment tab now toggles each device instance independently.
  - source labels in agents tab no longer show technical suffixes in parentheses.
* Updated `SettingsDialog` source options with `schemaId` metadata and beacon-id enablement by resolved schema.
* Expanded tests:
  - `src/test/deviceSettings.test.ts` for V1/V2->V3 migration and runtime selection,
  - `src/test/equipmentScreen.test.tsx` for validation switch and multi-instance save flow,
  - `src/test/settingsDialog.test.tsx` for instance-based source selection in agents tab,
  - `src/test/divers.test.ts` to preserve instance-based `navigation_source`.
* Verification:
  - `npm run typecheck` ✅
  - `npm run lint` ✅
  - `npm run test` ✅ (150 tests)
  - `npm run build` ✅
