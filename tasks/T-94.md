# T-94: Prefer network tiles when online (cache only offline)

**Issue:** #94
**Spec:** R-050 (offline tile cache) + New requirement clarification

## Context
The basemap currently uses a custom Leaflet `GridLayer` to read/write tiles from IndexedDB cache:
* Layer: `src/components/map/CachedTileLayer.tsx`
  - logic today: try cache first (including parent-tile hierarchy for overzoom) then try `fetch(url)` and cache the result.
* Cache store: `src/features/map/offlineTiles/tileCache.ts` (IndexedDB, LRU eviction).
* Tile URL: `src/features/map/offlineTiles/tileUrl.ts`.

Issue: this "cache-first" behavior makes the basemap look stale even when online. The desired behavior is:
* online: network-first (fresh tiles) with cache as fallback
* offline: cache-first

## Goal
* Change `CachedTileLayer` strategy:
  - When online: attempt network fetch first; on failure, fall back to cached hierarchy.
  - When offline: use cached hierarchy first; do not attempt network (or attempt only if desired by spec).
* Keep current overzoom parent-tile fallback behavior.
* Ensure cached tiles still get updated when online.

## Proposed detection rules (MVP)
* Use `navigator.onLine` as a quick signal.
* Add listeners for `window.addEventListener('online'|'offline')` to update an internal `isOnline` flag.
* Treat fetch errors as "offline" for that request and use cache fallback.

Optional (dev): add a `forceOffline` flag (not required unless needed for debugging).

## Implementation plan (agent)
1) Spec
* Update `spec/spec.md` under R-050 to explicitly define loading strategy:
  - online: network-first, cache fallback
  - offline: cache-first

2) Refactor `CachedTileLayer` loading sequence
* In `src/components/map/CachedTileLayer.tsx`:
  - Extract helpers:
    - `loadFromCacheHierarchy(coords)` (already exists inline)
    - `loadFromNetwork(coords)` which fetches the requested tile at `startSourceZoom`, stores it, returns blob
  - Implement branching:
    - if `isOnline`:
      - try `loadFromNetwork` -> apply
      - if network fails -> try cache hierarchy -> apply
    - else:
      - try cache hierarchy -> apply
      - (optional) skip network entirely
  - Ensure that if network tile loads successfully, it overwrites old cached tile.

3) Tests
* Add unit tests with mocked `fetch` and mocked TileCache:
  - online + fetch ok: `cache.get` is NOT called before fetch (or is called only as fallback), and `cache.put` happens.
  - online + fetch fails: falls back to cache (get called), no crash.
  - offline: does not call fetch, uses cache.

Testing approach options:
* Option A (preferred): extract the strategy into a pure function/module under `src/features/map/offlineTiles/` and test that directly.
* Option B: test `CachedTileLayer` behavior via jsdom by mocking `navigator.onLine`, `fetch`, and `getTileCache()`.

4) Verify
* `npm run typecheck && npm run lint && npm run test`

## Acceptance
* When online, the basemap updates from network and still caches tiles.
* When offline, the basemap uses cached tiles (including parent-tile overzoom) and does not appear "stuck" online.
* Tests cover both modes and fallback behavior.

## Progress log
- [x] Updated `spec/spec.md` (`R-050`) with adaptive strategy:
  - online: `network-first` + cache fallback;
  - offline: `cache-first` without mandatory network request.
- [x] Refactored tile source selection into pure strategy module:
  - `src/features/map/offlineTiles/tileLoadStrategy.ts`.
- [x] Updated `src/components/map/CachedTileLayer.tsx`:
  - added `navigator.onLine` driven state with `online/offline` listeners;
  - online path now tries network first and falls back to cache hierarchy on request errors;
  - offline path uses cache hierarchy only;
  - preserved overzoom parent-tile fallback and cache overwrite on successful network fetch.
- [x] Added unit tests for strategy:
  - `src/test/tileLoadStrategy.test.ts` (online success, online fallback, offline cache-only).
- [x] Verification completed:
  - `npm run typecheck` ✅
  - `npm run lint` ✅
  - `npm run test` ✅ (`41` files, `161` tests)
