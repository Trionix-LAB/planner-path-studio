# T-87: GNSS receiver via COM port (NMEA 0183)

**Issue:** #87
**Spec:** New requirement

## Context
Existing GNSS integration is UDP-based:
* Device schema: `src/features/devices/schemas/gnss-udp.ui.yaml`
* Schema loader: `src/features/devices/model/schemaLoader.ts`
* Runtime mapping from equipment settings: `src/features/devices/model/settings.ts` (buildEquipmentRuntime)
* NMEA parsing: `src/features/devices/gnss-udp/protocol.ts`
* Telemetry provider contract and Electron integration guidance:
  - `docs/features/gnss-udp-integration.md`
  - `docs/electron-telemetry-provider.md`

We need an Electron-only GNSS transport over serial/COM-port that publishes fixes using the same normalized telemetry flow.

Important: as of recent work, equipment supports multiple device instances per profile (schema v3). A new GNSS device should follow the same instance model.

## Goal
* Add a new equipment device type for GNSS over COM port (serial) that reads NMEA 0183.
* Allow selecting this source for base station and agents (via navigation source assignment UI).
* Implement Electron runtime transport in main process and deliver data to renderer through IPC following the existing GNSS bridge pattern.
* Reuse the existing NMEA parser to avoid protocol duplication.

## Spec/doc updates required
* `docs/devices.md`: add a new device section for GNSS-COM following the same template as existing devices (e.g. GNSS-UDP / Zima2R) and include the configuration schema table (field name, input form, mask, default).
* `docs/screens.md`: if needed, mention COM-port GNSS in equipment flows.
* `spec/spec.md`: add/extend a requirement for GNSS COM-port source, including connection state behavior and configuration fields.

## Implementation plan (agent)
1) Device schema + loader
* Create a NEW device UI schema file: `src/features/devices/schemas/gnss-com.ui.yaml` (schema id recommended: `gnss-com`).
  - Fields (MVP):
    - `comPort` (text-line), default empty or OS-specific example
    - `baudRate` (number/text-line with integer validation), default 115200 (or per docs)
  - Optional later: `dataBits`, `parity`, `stopBits`.
* Register schema in `src/features/devices/model/schemaLoader.ts` alongside zima2r and gnss-udp.

* Documentation MUST include the device schema (same as other devices):
  - In `docs/devices.md` add a `# <N>. GNSS-COM` section with:
    - short description
    - config fields list
    - protocol notes (NMEA 0183)
    - a "Схема конфигурации" table that mirrors the YAML fields (`comPort`, `baudRate`, ...)

2) Equipment runtime mapping
* Update `src/features/devices/model/types.ts` runtime type to include `gnss_com` (or similar) with:
  - `interface: 'serial'`
  - `protocol: 'nmea0183'`
  - `comPort`, `baudRate`
  - `instance_id`, `instance_name`
* Update `buildEquipmentRuntime()` in `src/features/devices/model/settings.ts`:
  - pick primary instance for `schema_id === 'gnss-com'`
  - map config fields to runtime

3) Electron transport (main process)
* Add serial port implementation in Electron main process:
  - Use a serial library compatible with Electron (e.g. `serialport`).
  - Open port with `baudRate` and read stream as bytes -> lines.
  - Split into NMEA lines (handle partial chunks) and send to renderer via IPC channel (similar to existing GNSS UDP bridge).
* Update `electron/preload.cjs` to expose a `gnssCom` API:
  - `start(config)` / `stop()`
  - `onData(listener)` / `onStatus(listener)` / `onError(listener)`
* Update `electron/main.cjs`:
  - register IPC handlers
  - ensure lifecycle cleanup on stop/window close
  - emit connection states `ok/timeout/error`.

4) Renderer provider wiring
* In `src/features/mission/model/telemetry.ts`:
  - Add a provider/bridge similar to `GNSS-UDP` but reading from `electronAPI.gnssCom`.
  - Reuse `parseNmeaLine` from `src/features/devices/gnss-udp/protocol.ts`.
  - Emit `TelemetryFix` with:
    - `entity_type/entity_id` routing
    - `navigation_source_id` = selected device instance id (IMPORTANT with multi-instance equipment)

5) UI: navigation source selection
* Ensure navigation sources list includes GNSS-COM instances from active equipment profile.
  - If sources are built in `MapWorkspace` from `EquipmentRuntime`, extend to include the new runtime entry.
  - Display label should include instance name (e.g. `GNSS-COM 1`).

6) Tests
* Unit:
  - settings normalization/runtime mapping for `gnss-com` instances (`src/test/deviceSettings.test.ts`).
  - NMEA parsing is already covered; add minimal coverage for provider routing using mocked electron API.
* Integration (renderer-side):
  - fake `electronAPI.gnssCom` emitting NMEA lines and connection states; verify `TelemetryFix` emission and `ok/timeout/error` transitions.

7) Verify
* `npm run typecheck`
* `npm run lint`
* `npm run test`

## Acceptance checklist
* Equipment UI can configure GNSS COM-port device instance(s) and mark a primary.
* Electron runtime can connect/disconnect to COM-port and emit normalized fixes.
* GNSS-COM can be selected as navigation source for base station and agents.
* Connection state semantics match `docs/electron-telemetry-provider.md`.
* Tests cover mapping + basic provider behavior.

## Progress log
- [x] Added `gnss-com` device schema and loader registration.
- [x] Added runtime mapping (`runtime.gnss_com`) with `autoDetectPort`, `comPort`, `baudRate`, `instance_id`.
- [x] Added COM-port suggestions in device form and bound `comPort` availability to `!autoDetectPort` via `enabledBy`.
- [x] Implemented Electron `gnssCom` bridge channels (`start/stop/status/listPorts`) in main/preload.
- [x] Implemented COM auto-detection: iterate available serial ports and probe for NMEA stream.
- [x] Added renderer telemetry provider for `gnss-com` and wired it in `MapWorkspace`.
- [x] Updated specs/docs for GNSS-COM behavior and UI blocking rule.
- [x] Added GNSS-COM simulator spec and implementation:
  - spec: `docs/features/gnss-com-simulator.md`
  - runtime: `electron/gnss-com-simulator.cjs`
  - CLI: `tools/gnss-com-sim.cjs` + npm script `gnss-com:sim`
- [x] Updated GNSS-COM simulator: virtual COM pair is created automatically (socat) and app port is printed in startup status.
- [x] Updated GNSS-COM bridge auto-detect: includes simulator virtual port from `/tmp/planner-gnss-com-sim.json` and `/tmp/gnss-com*`.
- [x] Run full verification (`typecheck`, `lint`, `test`).
- [x] Replaced native `datalist` in `DeviceSchemaForm` with controlled COM combobox (`Popover + Command`) to fix close/scroll UX and manual value entry.
- [x] Added UI regression tests for COM combobox behavior (`src/test/deviceSchemaForm.test.tsx`).
- [x] Updated GNSS-COM validation and resolve flow for manual mode: `comPort` accepts real port name/path (non-empty), with optional Windows numeric resolve compatibility in Electron bridge; extended validation tests across schemas.
- [x] Switched GNSS-COM ComboBox to real system port names/paths (no synthetic `COM...` labels), aligned manual validation with non-empty real port value, and documented simulator startup for Linux/macOS/Windows in `README.md`.
