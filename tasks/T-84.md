# T-84: Offline tile cache for map baselayer

**Issue:** #84
**Spec:** New requirement

## Context
* Базовая подложка карты рендерится через `react-leaflet` `TileLayer` в `src/components/map/MapCanvas.tsx`.
* URL и параметры тайлов идут из platform map contract (`src/platform/mapConfig.ts`, `src/platform/contracts.ts`).
* Сейчас при отсутствии сети тайлы не подгружаются и карта теряет подложку.

## Goal
* Добавить кэш тайлов для offline работы: заранее скачать область/зумы и показывать закэшированные тайлы без сети.
* Ограничить размер кэша и реализовать eviction (LRU/по времени/по объему).
* Добавить UX для предзагрузки (bbox + zoom range) и статусы (progress, size).

## Recommended technical approach (handoff)
Минимизировать изменения платформы и работать в renderer:

* Хранилище: IndexedDB (Blob/ArrayBuffer) + метаданные (lastAccess, sizeBytes, createdAt).
  - Плюсы: работает и в web, и в Electron renderer; без расширения `platform.fileStore` (сейчас только text API).
  - Минусы: управлять объемом/eviction вручную.
* Рендер: заменить базовый `TileLayer` на кастомный слой `CachedTileLayer` (Leaflet `GridLayer`), который:
  - по ключу `{provider}|{z}|{x}|{y}` сначала читает из cache
  - при cache miss пробует загрузить по сети, сохраняет в cache, затем отображает
  - при offline/ошибке сети отображает placeholder (серый тайл) и не спамит ошибками

* Предзагрузка: отдельный сервис `tilePrefetcher`:
  - принимает bbox (в lat/lon) и zoom range
  - вычисляет tile range для каждого zoom
  - скачивает батчами (concurrency limit) + пишет в cache
  - обновляет прогресс

* Eviction:
  - конфиг `maxCacheBytes` (например 512MB по умолчанию) + стратегия LRU
  - при добавлении тайла: если превышен лимит, удалять наименее используемые до достижения порога

## UX scope (MVP)
* В Settings или на экране карты добавить диалог "Offline карты":
  - кнопка "Выбрать область" (берем текущий viewport bbox) + ручные поля bbox (опционально)
  - zoom min/max (с дефолтами)
  - кнопки: Start download / Stop / Clear cache
  - отображение: tiles queued/downloaded, size, hits/misses (упрощенно)

## Plan
* [x] Spec: описать R-0xx в `spec/spec.md`:
  - что именно кэшируется (provider url + overlay? только base?)
  - лимит размера и стратегия eviction
  - поведение offline-first
  - UX предзагрузки (bbox+zoom)
  - лицензии/attribution (не нарушать провайдерские условия)
* [x] Implement cache store:
  - `src/features/map/offlineTiles/` (или `src/features/map/model/`):
    - `tileCache.ts` (get/put/markAccess/evict)
    - schema/indexeddb wrappers
* [x] Implement renderer layer:
  - `src/components/map/CachedTileLayer.tsx` (Leaflet GridLayer)
  - заменить `TileLayer` в `src/components/map/MapCanvas.tsx` на `CachedTileLayer`
* [x] Implement prefetcher:
  - `tilePrefetcher.ts` + cancellation
  - bbox->tiles conversion utilities
* [x] UI:
  - добавить диалог (например `src/components/dialogs/OfflineMapsDialog.tsx`)
  - wiring в toolbar/settings
* [x] Logging/metrics:
  - счетчики hits/misses, downloaded bytes, evicted tiles
* [x] Tests:
  - unit: bbox->tile ranges, LRU eviction, cache get/put
  - integration (jsdom): prefetcher uses mocked fetch and fills cache
* [ ] Verify: `npm run typecheck`, `npm run lint`, `npm run test`

## Acceptance
* [x] Пользователь может предзагрузить тайлы для области/зумов и затем видеть подложку без сети (для предзагруженной области).
* [x] Кэш ограничен по размеру, eviction работает и не приводит к неконтролируемому росту.
* [x] Есть базовые тесты на кэш и prefetch.
