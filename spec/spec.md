Спецификация для MVP карт

См. также:
- [docs/mission-format.md](../docs/mission-format.md) - формат хранения миссий (папка миссии, `mission.json`, CSV/GeoJSON).
- [docs/screens.md](../docs/screens.md) - основные экраны и навигация MVP.

## Термины и сущности

- **Базовая станция**: метка на карте, отражающая положение базовой станции.
- **Агент**: объект, чья позиция/параметры обновляются в реальном времени.
- **Трек**: последовательность точек (позиция + время + параметры), полученных в реальном времени, визуализируемая линией.
- **Маршрут**: пользовательский объект планирования (ломаная линия).
- **Зона обследования**: полигон, по которому генерируются галсы.
- **Галсы**: набор параллельных линий, автоматически сгенерированных внутри зоны обследования.
- **Точка-маркер**: пользовательская точка с названием и описанием.
- **Слой**: группа объектов одного типа (трек, маршруты/галсы, точки, служебные слои).
- **Миссия**: контейнер, объединяющий треки, точки, маршруты/галсы и связанные файлы/логи.
- **Черновик**: несохраненное состояние работы с картой (без созданной миссии).

**Базовые функции**

R-001 — Отображение карты: Отображение карты в виде подложки (OpenStreetMap).

R-002 — Система координат и масштабирование: Линейка и размерная сетка в метрах, для удобной визуальной оценки расстояний.

   R-002 — Подтребования (координаты/масштаб):
   - **Входные координаты** и расчетные значения (скорость/курс) считаются заданными в географических координатах WGS84 (lat/lon).
   - **Отображение OSM**: проекция Web Mercator (EPSG:3857), как у стандартных тайлов OSM.
   - **Отображение координат**:
     - В HUD: lat/lon в десятичных градусах с настраиваемой точностью (по умолчанию 6 знаков после запятой).
     - В строке состояния (под курсором): lat/lon в десятичных градусах (по умолчанию 6 знаков).
   - **Линейка масштаба**: обязательна, в метрах/километрах, автоматически подбирает шаг по текущему масштабу.
   - **Размерная сетка в метрах (опционально включаемая)**:
     - шаг сетки в метрах, выбирается автоматически по текущему зуму (масштабируется вместе с картой)
     - привязка и шаг рассчитываются в метрах в проекции измерений
     - рекомендуемый подход для MVP: локальная UTM-зона, вычисляемая по текущему центру карты (EPSG:326xx/327xx), с пересчетом линий сетки в WGS84 для отрисовки
     - допустимая погрешность визуальной сетки: до 1% на экране
R-003 — Агенты (реальное время): На карте отображается иконка (метка), представляющая агента; курс вычисляется over ground. Отображается метка базовой станции.

R-004 — Обновление позиции и индикация связи: Позиция метки обновляется в реальном времени по поступающим данным ГА. Предусмотреть визуальную индикацию потери связи (таймаут), если данные не обновляются.
R-005 — Построение трека: Автоматическое построение и отображение линии (трека) пройденного агентом пути.

R-006 — HUD: Информационная панель с текущими параметрами (Координаты, Скорость, Курс, Глубина).

R-007 — Режим слежения: Опция автоматического центрирования карты на агенте.

R-008 — Строка состояния: Отображение координат под курсором мыши в нижней части экрана.
   

**Планирование работ**

R-009 — Построение маршрутов: Построение маршрута ломанной линией как на Рисунке 1.

R-010 — Генерация галсов: Инструмент для построения полигонов зоны и автоматической генерации галсов внутри неё.
   R-010 — Параметры генерации галсов:
   * Угол: 0 (вдоль главной оси зоны) или 90 (поперек).
   * Ширина галса: определяет расстояние между линиями (чем больше ширина, тем меньше галсов).
   * (Опционально) выход за границы зоны: в MVP не учитывается (галсы клипаются по границе).
   Пример на Рисунке 2

R-011 — Точки-маркеры: Возможность ставить точки-маркеры на карту с прикрепленным текстовым описанием (напр., "Обломки", "Кабель", "Зацеп"). При наведении отображается ее название.

R-012 — Менеджер слоев: Позволяющий скрыть тот или иной слой на карте. Слой положения агента отключить нельзя. Отключить можно только слой:  
* пользовательских меток
* трека
* маршрутов (включает в себя как ручные маршруты, так и сгенерированные галсы)

	Пример на Рисунке 4.
Рисунок 4 - Менеджер слоев

**Управление миссиями**
Миссия — это контейнер, который объединяет: текущий трек(и), точки, маршруты, логи.

R-013 — Черновик: Возможность начать работу с картой без создания миссии (режим "черновика").
    - Цель: быстрый старт работы без лишних диалогов. Пользователь может накидать объекты/маршруты и начать работу.
    - Ограничение: полноценная работа с оборудованием/записью трека требует миссии (или переводит черновик в миссию), но "офисная" работа (планирование) доступна сразу.
    - Пользователь может сохранить черновик как новую миссию в любой момент.
    Рисунок 5 - Меню преконфигурации

R-018 — Создание/сохранение миссии: Возможность создать и сохранить миссию с определенным именем.
     - при создании миссии пользователь сразу выбирает папку хранения
       - по умолчанию: выбирается "родительская" папка, а приложение создает внутри нее подпапку с именем миссии
       - допустимая альтернатива: пользователь выбирает уже готовую (пустую) папку миссии
     - приложение создает структуру папки миссии (см. ниже) и начинает автосохранение в нее

R-019 — Открытие миссии: Возможность открыть миссию.

R-020 — Формат сохранения миссии: Сохранение миссии в виде папки с файлами треков, маршрутов, точек и тп.
     - при сохранении черновика как миссии пользователь выбирает папку хранения миссии
     - после сохранения черновик считается "преобразованным" в миссию, дальнейшие изменения пишутся в папку миссии

R-021 — Экспорт данных: Возможность экспортировать трек, маршрут, точки:
* Экспорт трека в формате GPX/KML.
* Экспорт маршрута в формате GPX/KML.
* Экспорт точек с описанием в CSV/GPX.  


## Требования: Миссии (R-014)

R-014 — Миссии

- Контекст: Стартовый экран и диалог открытия миссии должны показывать единый список миссий.
- Источник данных: список формируется из хранилища миссий (`fileStore.list`) и включает только папки, содержащие `mission.json`.
- Сортировка:
  - Поддерживается сортировка по дате (по умолчанию) и по имени.
  - По дате: сортировка по времени последнего изменения миссии — в приоритете файловая дата (`mtime`) если доступна (Electron), иначе `mission.json.updated_at`.
- Навигация и лимиты:
  - Список отображается постранично.
  - Лимит на странице: 5 миссий.
  - При наличии большего количества миссий отображаются элементы навигации по страницам.
- Представление: отображается `mission.name` (если есть) или имя папки, полный путь и human-readable дата последнего изменения.
- Пустое состояние: при отсутствии доступных миссий показывается понятный placeholder ("Нет доступных миссий").
- Поведение: обе точки входа (StartScreen и OpenMissionDialog) используют одну и ту же реализацию/хук; клик по записи открывает миссию.
- Acceptance: реализация покрыта unit-тестами для загрузки, сортировки, пагинации и пустого состояния.
  

## Доработки и уточнения для MVP (без изменения интеграции ГА)

### Поведение трека и индикация связи

R-022 — Множественные треки: В одной миссии поддерживается несколько треков, в том числе для разных агентов параллельно.

    Трек в миссии = «сессия записи» (например: до/после паузы, отдельные заплывы, разные участки работ). Каждый трек привязан к агенту через `agent_id`.
R-023 — Управление записью трека (per-agent):
   - запись трека управляется per-agent: каждый агент имеет независимое состояние (recording / paused / stopped)
   - в режиме миссии запись трека **не** включается автоматически для всех агентов; пользователь явно включает запись для нужных агентов через панель «Агенты»
   - пользователь может поставить запись на паузу и возобновить для каждого агента независимо
   - во время паузы: трек агента не пополняется (точки не пишутся в CSV), но метка агента / HUD продолжают обновляться в реальном времени
   - пауза закрывает текущий активный трек агента (ставится `ended_at`), запись выключается
   - при возобновлении после паузы создается новый активный трек для данного агента (новый CSV-файл)
   - также доступно явное действие «Завершить трек» (закрывает текущий трек и оставляет запись выключенной)
   - `ended_at` для трека ставится:
      - вручную (пауза/завершить трек)
      - автоматически при закрытии миссии/приложения, если трек был активен
   - `started_at/ended_at` фиксируются по системному времени приложения (в UTC, ISO-8601 с суффиксом `Z`)
R-024 — Разрывы трека при потере связи (таймаут):
   - при срабатывании таймаута связи линия не дорисовывается прямой линией до следующей точки
   - потеря связи **не закрывает** трек (не ставит `ended_at`), а только создает разрыв визуализации
   - при восстановлении связи продолжается тот же трек, но начинается новый сегмент (см. `segment_id`)
   - `segment_id` увеличивается на событии "соединение потеряно -> соединение восстановлено" (каждый разрыв = новый сегмент)
R-025 — Формат хранения трека: CSV.
   - Детальное описание формата CSV, имен файлов и заголовков см. в [docs/mission-format.md](../docs/mission-format.md).
   - Основные принципы:
     - один файл = один трек (сессия записи)
     - разделитель: запятая `,` (RFC4180)
     - разрывы трека (таймауты) обозначаются увеличением `segment_id`, файл при этом не закрывается
R-026 — Черновик и автосохранение: Режим черновика — трек и объекты существуют до закрытия приложения; рекомендуется автосохранение черновика (см. ниже).

### Операции с объектами (минимальный CRUD/UX)

R-027 — Общие операции с объектами:
   - выбор объекта кликом; выделенный объект имеет визуальную подсветку
   - удаление выделенного объекта (маршрут/точка/зона/галсы) через `Delete` и/или контекстное меню
   - переименование и редактирование свойств через панель/диалог "Свойства"
R-028 — Маршрут (ломаная линия):
   - построение: клики для добавления вершин; завершение двойным кликом или кнопкой "Завершить"
   - редактирование: перетаскивание вершин; добавление вершины кликом по сегменту; удаление вершины
   - атрибуты маршрута (минимум): имя, заметка (опционально), длина (вычисляемая)
   - измерения:
     - отображение общей длины маршрута (в метрах/км)
     - отображение длины каждого сегмента (отрезка) маршрута
     - режим отображения длины сегментов: `off`/`on-select`/`always` (по умолчанию: `on-select`)
R-029 — Зона обследования и галсы:
   - пользователь рисует полигон зоны (аналогично маршруту, но замкнутый)
   - галсы генерируются автоматически по параметрам (угол 0/90, ширина)
   - при изменении полигона зоны или параметров генерации галсы перегенерируются
   - визуализация (рекомендуется): направление прохода + нумерация (опционально)
R-030 — Точки-маркеры:
   - атрибуты точки (минимум): имя (показывается при наведении), описание (многострочное)
   - редактирование: перемещение перетаскиванием; изменение имени/описания

### Менеджер слоев (уточнение)

R-031 — Слой агента: Слой агента отключить нельзя. Слой базовой станции по умолчанию включен (можно сделать отключаемым).

R-032 — Состояние слоев: Состояние слоев сохраняется в рамках миссии (и отдельно в черновике).

### Миссии: формат хранения, автосохранение, совместимость

R-033 — Формат миссии: Структура и форматы файлов миссии детально описаны в [docs/mission-format.md](../docs/mission-format.md).
   - Папка миссии содержит `mission.json` (метаданные) и подпапки для треков, маршрутов, маркеров.

R-034 — Версионирование: поддерживается `schema_version` в `mission.json`.
R-035 — Внутренние форматы: 
   - маршруты/зоны/галсы/точки: GeoJSON.
   - треки: CSV.
   - См. [docs/mission-format.md](../docs/mission-format.md) для полных схем.

R-036 — Автосохранение:
   - в режиме миссии: изменения (объекты планирования) сохраняются автоматически с дебаунсом (например, 1-2 секунды после изменения)
   - в режиме черновика: автосохранение в `draft/` (в пользовательских данных приложения) + предложение "восстановить черновик" при старте
R-037 — Защита от параллельного открытия: при открытой миссии приложение держит "лок" (например, файл `mission.lock`) чтобы избежать редактирования двумя экземплярами

### Импорт/оффлайн/лимиты (явная фиксация scope)

R-038 — Импорт: для MVP импорт GPX/KML/CSV можно считать вне scope (это должно быть явно зафиксировано).

R-039 — Оффлайн: для MVP допускается требование доступа к интернету для подложки OSM; опционально — кеширование тайлов в пределах сессии.
R-040 — Ограничения и производительность (целевые ориентиры для MVP):
   - трек: до 200 000 точек без критичных лагов интерфейса (при необходимости включать упрощение геометрии по зуму)
   - объекты планирования: до ~1 000 вершин суммарно (маршруты + полигоны) без заметной деградации

### Настройки (минимум для MVP)

R-041 — Экран/панель настроек (минимум):
   - настройки должны сохраняться между запусками приложения
   - часть настроек является "глобальными" (по умолчанию для новых миссий), часть - сохраняется в миссии (см. ниже)
R-042 — Отображение измерений:
   - переключатель "Показывать линейку масштаба" (по умолчанию: включено)
   - переключатель "Показывать сетку в метрах" (по умолчанию: выключено)
   - настройка "Длины отрезков":
     - `off` (не показывать)
     - `on-select` (показывать только для выбранного объекта)
     - `always` (показывать всегда)
   - режим шага сетки:
     - `auto` (по умолчанию) - шаг выбирается по зуму
     - `manual` (опционально) - пользователь выбирает шаг из списка (например 10/20/50/100/200/500 м)
R-043 — Формат отображения координат:
   - в HUD и строке состояния: lat/lon (десятичные градусы), настраиваемая точность (по умолчанию 6 знаков)

R-044 — Внешний вид объектов на карте (настройки стилей):
   - трек: цвет, толщина линии; разрывы по `segment_id` визуально разделяются (разрыв/пунктир)
   - маршрут: цвет, толщина линии
   - зона обследования: цвет обводки, цвет/прозрачность заливки
   - галсы: цвет, толщина линии
   - точки-маркеры: иконка (MAY иметь несколько пресетов); подпись маркера — `hover` по умолчанию (режим `always` MAY быть реализован дополнительно)
   - агент/базовая станция: иконка/размер (можно ограничиться пресетом в MVP)

   Требования:
   - все цвета задаются в формате RGB/HEX (например `#FF6A00`)
   - стили применяются сразу без перезапуска

   Примечание для MVP:
   - Для MVP достаточно одного варианта иконки маркера и поведения подписи `hover`; дополнительные пресеты и режим `always` являются опциональными и могут быть реализованы позже.

R-045 — Хранение настроек:
   - Глобальные дефолты — в настройках приложения.
   - Переопределения для миссии — в `mission.json` (см. [docs/mission-format.md](../docs/mission-format.md)).
R-046 — Прочие настройки качества жизни:
   - поведение "режим слежения" (`follow_diver`) по умолчанию для новых миссий (включено/выключено)
   - "показывать трек/маршруты/точки" по умолчанию (согласуется с менеджером слоев)

## Требования: Запись трека нескольких агентов (R-015)

R-015 — Управление записью трека для нескольких агентов

- Контекст: Пользователь должен явно выбирать, трек какого агента (или агентов) записывать в данный момент. Это позволяет исключать лишние или шумные данные при работе с несколькими объектами.
- Мультиагентность: поддерживается параллельная запись треков для нескольких агентов одновременно. Каждый агент имеет независимое состояние записи (recording / paused / stopped) и свой набор треков.
- Интерфейс:
  - В левой панели секция «Агенты» заменяет прежнюю секцию «Треки миссии».
  - Для каждого агента отображается: название, цветной индикатор, состояние записи (пульсирующий индикатор при записи), кнопка записи/паузы, кнопка «Переместиться к».
  - При клике на агента он становится «выбранным»: HUD в правой панели переключается на его телеметрию, а в правой панели появляется список треков этого агента.
  - Список треков агента в правой панели аналогичен прежнему «Треки миссии», но отфильтрован по `agent_id`.
- Визуализация: При включении записи для агента UI показывает визуальный индикатор записи (иконка, цвет, подпись) как на панели агентов, так и на карте.
- Управление: Пользователь может начать, остановить или приостановить запись для любого агента независимо от других. По-умолчанию управление записи — per-agent через панель "Агенты"; дополнительно UI MAY предоставлять глобальный контрол (например, "Resume/Pause All"), но наличие такого глобального контрола не отменяет обязательность явного per-agent управления.
- Сохранение: Информация о том, какие агенты записываются (маппинг `agent_uid -> active_track_id`), сохраняется в `mission.json` в поле `active_tracks` и восстанавливается при переоткрытии приложения.
- Формат: Каждый трек в `mission.json` содержит поле `agent_id` (uid агента). Файлы треков именуются с префиксом агента: `tracks/<agent_uid>-track-NNNN.csv`.
- Acceptance: 
  - [ ] Переключатель записи доступен для каждого активного агента
  - [ ] Несколько агентов могут записывать треки параллельно
  - [ ] Включение/отключение записи визуально отмечается в UI и на карте
  - [ ] HUD переключается при выборе агента в левой панели
  - [ ] Треки агента отображаются в правой панели при его выборе
  - [ ] Данные о состоянии записи (`active_tracks`) сохраняются в структуре миссии
  - [ ] При перезапуске приложения состояние восстанавливается
  - [ ] Обратная совместимость: миссии без `active_tracks`/`agent_id` открываются корректно
  - [ ] Наличие глобального контрола (если он есть) явно задокументировано и не заменяет per-agent управление
   - кнопка "Сбросить настройки к значениям по умолчанию"

## Требования: Режимы входа в черновик (R-016)

R-016 — Разделение сценариев «Черновик» и «Восстановить черновик»

- На стартовом экране действие «Черновик» должно запускать новый пустой черновик.
- При запуске нового черновика предыдущий автосохраненный `draft/current` считается сброшенным.
- На стартовом экране действие «Восстановить черновик» должно открывать существующий автосохраненный `draft/current`.
- Если автосохраненного черновика нет, восстановление может показать предупреждение и создать новый пустой черновик.
- Кнопка «Восстановить черновик» отображается только при фактическом наличии recoverable draft.
- Различие поведений «Черновик» и «Восстановить черновик» покрыто unit-тестами.

## Требования: ID маяка и привязка к Zima (R-017)

R-017 — Настройка `ID маяка` в блоке «Агенты»

- Значение `ID маяка` для дефолтного агента должно начинаться с `0` и далее увеличиваться последовательно (`0, 1, 2, ...`) в рамках диапазона `0..15`.
- Контрол `ID маяка` в настройках агента должен быть активен только если:
  - в активном runtime-профиле назначено оборудование `Zima2R`,
  - у агента выбран источник навигации `zima2r`.
- Во всех остальных случаях контрол `ID маяка` должен быть disabled.
- Поведение контролла `ID маяка` и дефолтные значения покрываются unit/UI тестами.

## Требования: Release workflow (R-047)

R-047 — Автоматизация релизной сборки и публикации артефактов

- Репозиторий MUST содержать GitHub Actions workflow для сборки и публикации релизных артефактов.
- Workflow MUST запускаться по push тега `v*` и по ручному запуску `workflow_dispatch`.
- Workflow MUST выполнять сборку Electron-артефактов через `npm run electron:build` (минимум: Windows portable).
- Workflow MUST загружать артефакты как workflow artifacts, а при запуске по тегу — прикреплять их к GitHub Release.
- Release MUST создаваться/обновляться в режиме draft по умолчанию; перевод draft→published MUST быть явным (ручной input/условие).
- Workflow MUST выполняться без секретов подписи; шаги подписи MAY быть включены только при наличии нужных секретов.
- Документация MUST описывать процесс релиза и необходимые секреты.
