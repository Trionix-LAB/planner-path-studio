Спецификация для MVP карт

См. также:
- [docs/mission-format.md](../docs/mission-format.md) - формат хранения миссий (папка миссии, `mission.json`, CSV/GeoJSON).
- [docs/screens.md](../docs/screens.md) - основные экраны и навигация MVP.

## Термины и сущности

- **Базовая станция**: метка на карте, отражающая положение базовой станции.
- **Агент**: объект, чья позиция/параметры обновляются в реальном времени.
- **Трек**: последовательность точек (позиция + время + параметры), полученных в реальном времени, визуализируемая линией.
- **Маршрут**: пользовательский объект планирования (ломаная линия).
- **Зона обследования**: полигон, по которому генерируются галсы.
- **Галсы**: набор параллельных линий, автоматически сгенерированных внутри зоны обследования.
- **Точка-маркер**: пользовательская точка с названием и описанием.
- **Слой**: группа объектов одного типа (трек, маршруты/галсы, точки, служебные слои).
- **Миссия**: контейнер, объединяющий треки, точки, маршруты/галсы и связанные файлы/логи.
- **Черновик**: несохраненное состояние работы с картой (без созданной миссии).

**Базовые функции**

R-001 — Отображение карты: Отображение карты в виде подложки (OpenStreetMap).

R-002 — Система координат и масштабирование: Линейка и размерная сетка в метрах, для удобной визуальной оценки расстояний.

   R-002 — Подтребования (координаты/масштаб):
   - **Входные координаты** и расчетные значения (скорость/курс) считаются заданными в географических координатах WGS84 (lat/lon).
   - **Отображение OSM**: проекция Web Mercator (EPSG:3857), как у стандартных тайлов OSM.
   - **Отображение координат**:
     - В HUD: lat/lon в десятичных градусах с настраиваемой точностью (по умолчанию 6 знаков после запятой).
     - В строке состояния (под курсором): lat/lon в десятичных градусах (по умолчанию 6 знаков).
   - **Линейка масштаба**: обязательна, в метрах/километрах, автоматически подбирает шаг по текущему масштабу.
   - **Zoom-контракт карты**:
     - `maxNativeZoom` (native zoom тайл-источника OSM): `19`.
     - `maxZoom` (разрешенный UI zoom c overzoom): `22`.
     - При `fitBounds` MUST использоваться тот же `maxZoom`, чтобы автоматическое центрирование не вводило дополнительный локальный лимит.
     - Плавность zoom MUST быть настраиваемой (`zoomSnap`, `zoomDelta`, `wheelPxPerZoomLevel`), дефолт для MVP: `1`, `1`, `120`.
   - **Провайдер подложки**:
     - Подложка должна выбираться конфигурацией платформы (минимум: `osm`, `openmarine`) с fallback на OSM.
     - `openmarine` реализуется как связка OSM base layer + OpenSeaMap seamark overlay.
     - Для провайдеров с API-ключом конфигурация SHOULD использовать env-переменные и не хранить ключи в репозитории.
   - **Размерная сетка в метрах (опционально включаемая)**:
     - шаг сетки в метрах, выбирается автоматически по текущему зуму (масштабируется вместе с картой)
     - привязка и шаг рассчитываются в метрах в проекции измерений
     - рекомендуемый подход для MVP: локальная UTM-зона, вычисляемая по текущему центру карты (EPSG:326xx/327xx), с пересчетом линий сетки в WGS84 для отрисовки
     - допустимая погрешность визуальной сетки: до 1% на экране
R-003 — Агенты (реальное время): На карте отображается иконка (метка), представляющая агента; курс вычисляется over ground. Отображается метка базовой станции.

R-004 — Обновление позиции и индикация связи: Позиция метки обновляется в реальном времени по поступающим данным ГА. Предусмотреть визуальную индикацию потери связи (таймаут), если данные не обновляются.
R-005 — Построение трека: Автоматическое построение и отображение линии (трека) пройденного агентом пути.

R-006 — HUD: Информационная панель с текущими параметрами (Координаты, Скорость, Курс, Глубина).

R-007 — Режим слежения: Опция автоматического центрирования карты на агенте.

R-008 — Строка состояния: Отображение координат под курсором мыши в нижней части экрана.
   

**Планирование работ**

R-009 — Построение маршрутов: Построение маршрута ломанной линией как на Рисунке 1.

R-010 — Генерация галсов: Инструмент для построения полигонов зоны и автоматической генерации галсов внутри неё.
   R-010 — Параметры генерации галсов:
   * Угол: произвольный, задается как `laneAngle` (поворот относительно ориентации зоны `laneBearingDeg`).
   * Семантика угла:
     * `laneBearingDeg` задает базовую ориентацию оси зоны (авто по геометрии или вручную по выбранной грани).
     * `laneAngle` задает поворот относительно этой базовой ориентации.
   * Диапазон пользовательского ввода `laneAngle`: `[0, 360]`.
   * Нормализация `laneAngle`: перед расчетом значение приводится к диапазону `[0, 180)` (недиректная ось, `0 == 180`).
   * Формат ввода угла: числовой (`number`), UI-шаг по умолчанию `1°`; допускаются целые и дробные значения.
   * Ширина галса: определяет расстояние между линиями (чем больше ширина, тем меньше галсов).
   * (Опционально) выход за границы зоны: в MVP не учитывается (галсы клипаются по границе).
   Пример на Рисунке 2

R-011 — Точки-маркеры: Возможность ставить точки-маркеры на карту с прикрепленным текстовым описанием (напр., "Обломки", "Кабель", "Зацеп"). При наведении отображается ее название.

R-012 — Менеджер слоев: Позволяющий скрыть тот или иной слой на карте. Слой положения агента отключить нельзя. Отключить можно только слой:  
* пользовательских меток
* трека
* маршрутов (включает в себя как ручные маршруты, так и сгенерированные галсы)

	Пример на Рисунке 4.
Рисунок 4 - Менеджер слоев

**Управление миссиями**
Миссия — это контейнер, который объединяет: текущий трек(и), точки, маршруты, логи.

R-013 — Черновик: Возможность начать работу с картой без создания миссии (режим "черновика").
    - Цель: быстрый старт работы без лишних диалогов. Пользователь может накидать объекты/маршруты и начать работу.
    - Ограничение: полноценная работа с оборудованием/записью трека требует миссии (или переводит черновик в миссию), но "офисная" работа (планирование) доступна сразу.
    - Пользователь может сохранить черновик как новую миссию в любой момент.
    Рисунок 5 - Меню преконфигурации

R-018 — Создание/сохранение миссии: Возможность создать и сохранить миссию с определенным именем.
     - при создании миссии пользователь сразу выбирает папку хранения
       - по умолчанию: выбирается "родительская" папка, а приложение создает внутри нее подпапку с именем миссии
       - допустимая альтернатива: пользователь выбирает уже готовую (пустую) папку миссии
     - приложение создает структуру папки миссии (см. ниже) и начинает автосохранение в нее

R-019 — Открытие миссии: Возможность открыть миссию.

R-020 — Формат сохранения миссии: Сохранение миссии в виде папки с файлами треков, маршрутов, точек и тп.
     - при сохранении черновика как миссии пользователь выбирает папку хранения миссии
     - после сохранения черновик считается "преобразованным" в миссию, дальнейшие изменения пишутся в папку миссии

R-021 — Экспорт данных: Возможность экспортировать трек, маршрут, точки:
* Экспорт трека в формате GPX/KML.
* Экспорт маршрута в формате GPX/KML.
* Экспорт точек с описанием в CSV/GPX.  


## Требования: Миссии (R-014)

R-014 — Показ миссий

- Контекст: Стартовый экран и диалог открытия миссии должны показывать единый, синхронизованный список миссий.
- Источник данных: список формируется из хранилища миссий (`fileStore.list`) и включает только папки, содержащие `mission.json`.
- Порядок: сортировка по умолчанию по времени последнего изменения миссии — в приоритете файловая дата (`mtime`) если доступна (Electron), иначе `mission.json.updated_at`. Доступны опции сортировки: по дате (убыванию/возрастанию) и по имени (алфавитно).
- Представление: отображается `mission.name` (если есть) или имя папки, полный путь и human-readable дата последнего изменения. Доступны элементы управления сортировкой.
- Навигация: поддержка пагинации для просмотра всех миссий, с отображением 5 записей на странице по умолчанию.
- Ограничение: отображаемый лимит — 5 записей по умолчанию; должен быть легко конфигурируем (параметр в хук/функцию, UI-настройка не требуется для MVP).
- Пустое состояние: при отсутствии доступных миссий показывается понятный placeholder ("Нет доступных миссий").
- Поведение: обе точки входа (StartScreen и OpenMissionDialog) используют одну и ту же реализацию/хук; клик по записи открывает миссию.
- Acceptance: реализация покрыта unit-тестами для загрузки, сортировки, пагинации и пустого состояния.
  

## Доработки и уточнения для MVP (без изменения интеграции ГА)

### Поведение трека и индикация связи

R-022 — Множественные треки: В одной миссии поддерживается несколько треков, в том числе для разных агентов параллельно.

    Трек в миссии = «сессия записи» (например: до/после паузы, отдельные заплывы, разные участки работ). Каждый трек привязан к агенту через `agent_id`.
R-023 — Управление записью трека (per-agent):
   - запись трека управляется per-agent: каждый агент имеет независимое состояние (recording / paused / stopped)
   - в режиме миссии запись трека **не** включается автоматически для всех агентов; пользователь явно включает запись для нужных агентов через панель «Агенты»
   - пользователь может поставить запись на паузу и возобновить для каждого агента независимо
   - во время паузы: трек агента не пополняется (точки не пишутся в CSV), но метка агента / HUD продолжают обновляться в реальном времени
   - пауза закрывает текущий активный трек агента (ставится `ended_at`), запись выключается
   - при возобновлении после паузы создается новый активный трек для данного агента (новый CSV-файл)
   - также доступно явное действие «Завершить трек» (закрывает текущий трек и оставляет запись выключенной)
   - `ended_at` для трека ставится:
      - вручную (пауза/завершить трек)
      - автоматически при закрытии миссии/приложения, если трек был активен
   - `started_at/ended_at` фиксируются по системному времени приложения (в UTC, ISO-8601 с суффиксом `Z`)
R-024 — Разрывы трека при потере связи (таймаут):
   - при срабатывании таймаута связи линия не дорисовывается прямой линией до следующей точки
   - потеря связи **не закрывает** трек (не ставит `ended_at`), а только создает разрыв визуализации
   - при восстановлении связи продолжается тот же трек, но начинается новый сегмент (см. `segment_id`)
   - `segment_id` увеличивается на событии "соединение потеряно -> соединение восстановлено" (каждый разрыв = новый сегмент)
R-025 — Формат хранения трека: CSV.
   - Детальное описание формата CSV, имен файлов и заголовков см. в [docs/mission-format.md](../docs/mission-format.md).
   - Основные принципы:
     - один файл = один трек (сессия записи)
     - разделитель: запятая `,` (RFC4180)
     - разрывы трека (таймауты) обозначаются увеличением `segment_id`, файл при этом не закрывается
R-026 — Черновик и автосохранение: Режим черновика — трек и объекты существуют до закрытия приложения; рекомендуется автосохранение черновика (см. ниже).

### Операции с объектами (минимальный CRUD/UX)

R-027 — Общие операции с объектами:
   - выбор объекта кликом; выделенный объект имеет визуальную подсветку
   - удаление выделенного объекта (маршрут/точка/зона/галсы) через `Delete` и/или контекстное меню
   - переименование и редактирование свойств через панель/диалог "Свойства"
R-028 — Маршрут (ломаная линия):
   - построение: клики для добавления вершин; завершение двойным кликом или кнопкой "Завершить"
   - редактирование: перетаскивание вершин; добавление вершины кликом по сегменту; удаление вершины
   - атрибуты маршрута (минимум): имя, заметка (опционально), длина (вычисляемая)
   - измерения:
     - отображение общей длины маршрута (в метрах/км)
     - отображение длины каждого сегмента (отрезка) маршрута
     - режим отображения длины сегментов: `off`/`on-select`/`always` (по умолчанию: `on-select`)
R-029 — Зона обследования и галсы:
   - пользователь рисует полигон зоны (аналогично маршруту, но замкнутый)
   - в MVP зона галсов всегда должна быть выпуклым многоугольником. Невыпуклые фигуры не должны генерироваться.
   - если пользователь ввел точки так, что зона получается невыпуклой, система MUST автоматически преобразовать ее в выпуклый многоугольник.
   - галсы генерируются автоматически по параметрам (произвольный угол, ширина)
   - при изменении полигона зоны или параметров генерации галсы перегенерируются
   - панель параметров галсов для черновика зоны MUST быть перетаскиваемой в пределах viewport.
   - панель MUST поддерживать сворачивание в компактную draggable-иконку с быстрым восстановлением по клику.
   - позиция панели/иконки и состояние свёрнутости должны сохраняться в рамках текущей сессии (без обязательного персиста между запусками).
   - по умолчанию панель не должна появляться под курсором и блокировать построение зоны.
   - визуализация (рекомендуется): направление прохода + нумерация (опционально)
R-030 — Точки-маркеры:
   - атрибуты точки (минимум): имя (показывается при наведении), описание (многострочное)
   - редактирование: перемещение перетаскиванием; изменение имени/описания

### Менеджер слоев (уточнение)

R-031 — Слой агента: Слой агента отключить нельзя. Слой базовой станции по умолчанию включен (можно сделать отключаемым).

R-032 — Состояние слоев: Состояние слоев сохраняется в рамках миссии (и отдельно в черновике).

### Миссии: формат хранения, автосохранение, совместимость

R-033 — Формат миссии: Структура и форматы файлов миссии детально описаны в [docs/mission-format.md](../docs/mission-format.md).
   - Папка миссии содержит `mission.json` (метаданные) и подпапки для треков, маршрутов, маркеров.

R-034 — Версионирование: поддерживается `schema_version` в `mission.json`.
R-035 — Внутренние форматы: 
   - маршруты/зоны/галсы/точки: GeoJSON.
   - треки: CSV.
   - См. [docs/mission-format.md](../docs/mission-format.md) для полных схем.

R-036 — Автосохранение:
   - в режиме миссии: изменения (объекты планирования) сохраняются автоматически с дебаунсом (например, 1-2 секунды после изменения)
   - в режиме черновика: автосохранение в `draft/` (в пользовательских данных приложения) + предложение "восстановить черновик" при старте
R-037 — Защита от параллельного открытия: при открытой миссии приложение держит "лок" (например, файл `mission.lock`) чтобы избежать редактирования двумя экземплярами

### Импорт/оффлайн/лимиты (явная фиксация scope)

R-038 — Импорт: для MVP импорт GPX/KML/CSV можно считать вне scope (это должно быть явно зафиксировано).

R-039 — Оффлайн: для MVP допускается требование доступа к интернету для подложки OSM; опционально — кеширование тайлов в пределах сессии.
R-040 — Ограничения и производительность (целевые ориентиры для MVP):
   - трек: до 200 000 точек без критичных лагов интерфейса (при необходимости включать упрощение геометрии по зуму)
   - объекты планирования: до ~1 000 вершин суммарно (маршруты + полигоны) без заметной деградации

### Настройки (минимум для MVP)

R-041 — Экран/панель настроек (минимум):
   - настройки должны сохраняться между запусками приложения
   - часть настроек является "глобальными" (по умолчанию для новых миссий), часть - сохраняется в миссии (см. ниже)
R-042 — Отображение измерений:
   - переключатель "Показывать линейку масштаба" (по умолчанию: включено)
   - переключатель "Показывать сетку в метрах" (по умолчанию: выключено)
   - настройка "Длины отрезков":
     - `off` (не показывать)
     - `on-select` (показывать только для выбранного объекта)
     - `always` (показывать всегда)
   - режим шага сетки:
     - `auto` (по умолчанию) - шаг выбирается по зуму
     - `manual` (опционально) - пользователь выбирает шаг из списка (например 10/20/50/100/200/500 м)
R-043 — Формат отображения координат:
   - в HUD и строке состояния: lat/lon (десятичные градусы), настраиваемая точность (по умолчанию 6 знаков)

R-044 — Внешний вид объектов на карте (настройки стилей):
   - трек: цвет, толщина линии; разрывы по `segment_id` визуально разделяются (разрыв/пунктир)
   - маршрут: цвет, толщина линии
   - зона обследования: цвет обводки, цвет/прозрачность заливки
   - галсы: цвет, толщина линии
   - точки-маркеры: иконка (MAY иметь несколько пресетов); подпись маркера — `hover` по умолчанию (режим `always` MAY быть реализован дополнительно)
   - агент/базовая станция: иконка/размер (размер агента задается числом, не только пресетами)

   Требования:
   - все цвета задаются в формате RGB/HEX (например `#FF6A00`)
   - размер маркера агента задается числом в пикселях в диапазоне `1..256`
   - стили применяются сразу без перезапуска

   Примечание для MVP:
   - Для MVP достаточно одного варианта иконки маркера и поведения подписи `hover`; дополнительные пресеты и режим `always` являются опциональными и могут быть реализованы позже.

R-045 — Хранение настроек:
   - Глобальные дефолты — в настройках приложения.
   - Переопределения для миссии — в `mission.json` (см. [docs/mission-format.md](../docs/mission-format.md)).
R-046 — Прочие настройки качества жизни:
   - поведение "режим слежения" (`follow_diver`) по умолчанию для новых миссий (включено/выключено)
   - "показывать трек/маршруты/точки" по умолчанию (согласуется с менеджером слоев)

## Требования: Запись трека нескольких агентов (R-015)

R-015 — Управление записью трека для нескольких агентов

- Контекст: Пользователь должен явно выбирать, трек какого агента (или агентов) записывать в данный момент. Это позволяет исключать лишние или шумные данные при работе с несколькими объектами.
- Мультиагентность: поддерживается параллельная запись треков для нескольких агентов одновременно. Каждый агент имеет независимое состояние записи (recording / paused / stopped) и свой набор треков.
- Интерфейс:
  - В левой панели секция «Агенты» заменяет прежнюю секцию «Треки миссии».
  - Для каждого агента отображается: название, цветной индикатор, состояние записи (пульсирующий индикатор при записи), кнопка записи/паузы, кнопка «Переместиться к».
  - При клике на агента он становится «выбранным»: HUD в правой панели переключается на его телеметрию, а в правой панели появляется список треков этого агента.
  - Список треков агента в правой панели аналогичен прежнему «Треки миссии», но отфильтрован по `agent_id`.
- Визуализация: При включении записи для агента UI показывает визуальный индикатор записи (иконка, цвет, подпись) как на панели агентов, так и на карте.
- Управление: Пользователь может начать, остановить или приостановить запись для любого агента независимо от других. По-умолчанию управление записи — per-agent через панель "Агенты"; дополнительно UI MAY предоставлять глобальный контрол (например, "Resume/Pause All"), но наличие такого глобального контрола не отменяет обязательность явного per-agent управления.
- Сохранение: Информация о том, какие агенты записываются (маппинг `agent_uid -> active_track_id`), сохраняется в `mission.json` в поле `active_tracks` и восстанавливается при переоткрытии приложения.
- Формат: Каждый трек в `mission.json` содержит поле `agent_id` (uid агента). Файлы треков именуются с префиксом агента: `tracks/<agent_uid>-track-NNNN.csv`.
- Acceptance: 
  - [ ] Переключатель записи доступен для каждого активного агента
  - [ ] Несколько агентов могут записывать треки параллельно
  - [ ] Включение/отключение записи визуально отмечается в UI и на карте
  - [ ] HUD переключается при выборе агента в левой панели
  - [ ] Треки агента отображаются в правой панели при его выборе
  - [ ] Данные о состоянии записи (`active_tracks`) сохраняются в структуре миссии
  - [ ] При перезапуске приложения состояние восстанавливается
  - [ ] Обратная совместимость: миссии без `active_tracks`/`agent_id` открываются корректно
  - [ ] Наличие глобального контрола (если он есть) явно задокументировано и не заменяет per-agent управление
   - кнопка "Сбросить настройки к значениям по умолчанию"

## Требования: Режимы входа в черновик (R-016)

R-016 — Разделение сценариев «Черновик» и «Восстановить черновик»

- На стартовом экране действие «Черновик» должно запускать новый пустой черновик.
- При запуске нового черновика предыдущий автосохраненный `draft/current` считается сброшенным.
- На стартовом экране действие «Восстановить черновик» должно открывать существующий автосохраненный `draft/current`.
- Если автосохраненного черновика нет, восстановление может показать предупреждение и создать новый пустой черновик.
- Кнопка «Восстановить черновик» отображается только при фактическом наличии recoverable draft.
- Различие поведений «Черновик» и «Восстановить черновик» покрыто unit-тестами.

## Требования: ID маяка и привязка к Zima (R-017)

R-017 — Настройка `ID маяка` в блоке «Агенты»

- Значение `ID маяка` для дефолтного агента должно начинаться с `0` и далее увеличиваться последовательно (`0, 1, 2, ...`) в рамках диапазона `0..15`.
- Контрол `ID маяка` в настройках агента должен быть активен только если:
  - в активном runtime-профиле назначено оборудование `Zima2R`,
  - у агента выбран источник навигации `zima2r`.
- Во всех остальных случаях контрол `ID маяка` должен быть disabled.
- Поведение контролла `ID маяка` и дефолтные значения покрываются unit/UI тестами.

## Требования: Release workflow (R-047)

R-047 — Автоматизация релизной сборки и публикации артефактов

- Репозиторий MUST содержать GitHub Actions workflow для сборки и публикации релизных артефактов.
- Workflow MUST запускаться по push тега `v*` и по ручному запуску `workflow_dispatch`.
- Workflow MUST выполнять сборку Electron-артефактов через `npm run electron:build` (минимум: Windows portable).
- Workflow MUST загружать артефакты как workflow artifacts, а при запуске по тегу — прикреплять их к GitHub Release.
- Release MUST создаваться/обновляться в режиме draft по умолчанию; перевод draft→published MUST быть явным (ручной input/условие).
- Workflow MUST выполняться без секретов подписи; шаги подписи MAY быть включены только при наличии нужных секретов.
- Документация MUST описывать процесс релиза и необходимые секреты.

## Требования: Галсы (R-048)

R-048 — Регенерация галсов (UI):
   - Кнопка «Перегенерировать галсы» в панели свойств объекта MUST сохранять текущие значения параметров (угол, ширина, ориентация, старт) и немедленно запускать процесс перегенерации галсов.
   - Изменение любого параметра генерации (угол, ширина) должно приводить к появлению предупреждения «Галсы неактуальны», информирующего пользователя о рассогласовании параметров и отрисованных линий.
   - Предупреждение «Галсы неактуальны» НЕ должно содержать кнопку регенерации (дублирование функционала); основная кнопка внизу панели остается единственным способом ручного обновления.

## Требования: Рабочая область карты (R-049)

R-049 — Сворачиваемые панели рабочей области:
   - Верхняя панель инструментов (`TopToolbar`), левая панель (`LeftPanel`) и правая панель (`RightPanel`) MUST сворачиваться/разворачиваться независимо.
   - В свернутом состоянии соответствующая панель MUST освобождать место в layout, чтобы центральная область карты расширялась.
   - Контролы сворачивания/разворачивания MUST быть частью layout и НЕ должны перекрывать контент панелей/карты.
   - UI overlay-элементы (dropdown/dialog/toast) MUST отображаться поверх слоев карты и оставаться интерактивными независимо от состояния панелей.
   - Для каждой свернутой панели MUST быть видимый контрол восстановления (handle/button), доступный кликом и с клавиатуры.
   - Для левой/правой панели в свернутом состоянии MUST отображаться явная подпись вкладки (например, «Слои»/«Свойства») вместе с иконкой направления.
   - Состояние свёрнутости панелей MUST сохраняться между сессиями приложения и восстанавливаться при следующем открытии карты.

## Требования: Скачивание карт и оффлайн подложка (R-050)

R-050 — Скачивание карт и оффлайн-кэш тайлов базовой подложки:
   - Базовая подложка карты MUST работать в offline-first режиме: при наличии тайла в локальном кэше отображается кэшированная версия, при отсутствии — выполняется загрузка из сети.
   - Кэш MUST храниться локально в IndexedDB и ключеваться по комбинации `provider|z|x|y`.
   - Кэш MUST иметь ограничение размера (по умолчанию 512 MB) и MUST очищаться по LRU (наименее недавно использованные тайлы удаляются первыми).
   - Для пользователя MUST быть доступен диалог «Скачать карты»:
     - выбор центра области по `широте/долготе` (по текущему viewport и/или ручным вводом),
     - выбор диапазона zoom (`min/max`),
     - запуск/остановка загрузки,
     - очистка кэша.
   - Поля центра области MUST интерпретироваться как:
     - `Широта` в диапазоне `[-85; 85]`,
     - `Долгота` в диапазоне `[-180; 180]`.
   - Поля `zoom min/max` в UI MAY задаваться до общего `maxZoom` карты.
   - BBox для предзагрузки MUST автоматически вычисляться от указанного центра с использованием текущего размера viewport
     (если viewport недоступен, используется безопасный fallback-радиус).
   - Для предзагрузки MUST использоваться только реальные zoom-уровни источника (`<= maxNativeZoom`); если в UI введен больший zoom, он MUST быть автоматически ограничен до `maxNativeZoom` для скачивания.
   - При отсутствии тайла у провайдера (например `404`) или иных provider-level HTTP ошибках тайл MUST считаться `пропущенным` и НЕ должен срывать процесс загрузки.
   - Поврежденные/невалидные записи тайлов в кэше MUST автоматически удаляться и пере-загружаться при следующей попытке загрузки.
   - При отсутствии точного тайла в кэше в offline режиме SHOULD использоваться fallback по иерархии родительских тайлов (overzoom), чтобы минимизировать пустые зоны.
   - В диалоге MUST отображаться базовые метрики: прогресс, количество скачанных/пропущенных/ошибочных тайлов, текущий размер кэша, статистика кэша.
   - В offline режиме для отсутствующих тайлов MUST применяться fallback-отрисовка (placeholder/overzoom), чтобы избегать белых пустых областей карты.

## Требования: Табличное редактирование координат (R-051)

R-051 — Редактирование геометрии маршрута/зоны по координатам:
   - В панели свойств объекта MUST отображаться табличный редактор координат для:
     - `route` — секция «Точки маршрута» (редактируемая),
     - `zone` — секция «Вершины зоны» (редактируемая).
   - Таблица MUST поддерживать добавление и удаление строк, а также редактирование `широты/долготы` в каждой строке.
   - Валидация MUST выполняться при сохранении:
     - `lat` в диапазоне `[-90; 90]`,
     - `lon` в диапазоне `[-180; 180]`.
   - При невалидных значениях MUST показываться ошибка в UI, и изменения MUST NOT применяться к объекту.
   - Для секций координат (`route` «Точки маршрута», `zone` «Вершины зоны», `zone` «Вершины галсов`) SHOULD использоваться отдельные модальные окна, чтобы координаты читались и редактировались без ограничения узкой правой панели.
   - Минимальное число точек MUST соблюдаться:
     - `route` — не менее 2 точек,
     - `zone` — не менее 3 точек.
   - Для `zone` в панели свойств MUST отображаться отдельная read-only секция «Вершины галсов» с координатами сгенерированных линий.
   - Координаты в read-only секции галсов MUST обновляться при обновлении `laneFeatures` выбранной зоны.
   - Синхронизация карта↔таблица MUST быть двусторонней:
     - изменения из таблицы после сохранения обновляют геометрию на карте,
     - изменения геометрии на карте (drag/add/remove вершин) обновляют таблицу при следующем рендере выбранного объекта.

## Требования: Тема интерфейса (R-052)

R-052 — Поддержка светлой/темной темы:
   - Приложение MUST поддерживать минимум две темы интерфейса: `dark` и `light`.
   - Текущая тема MUST переключаться из окна настроек пользователя.
   - Выбор темы MUST сохраняться между сессиями приложения (персист в локальном хранилище).
   - Выбранная тема MUST применяться на старте приложения до отображения основной UI-области.
   - Для тем MUST использоваться единый набор CSS-токенов (через переменные), чтобы основные поверхности (панели, диалоги, формы, таблицы, toast) корректно рендерились в обоих режимах.
   - Контраст текста к фону в основных элементах интерфейса SHOULD соответствовать минимум уровню WCAG AA.
