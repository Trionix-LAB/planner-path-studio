name: Issue status:done on close

on:
  issues:
    types: [closed]

permissions:
  issues: write

jobs:
  label_done:
    runs-on: ubuntu-latest
    steps:
      - name: Add status:done label (and keep single status)
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const DONE = "status:done";
            const STATUS_PREFIX = "status:";

            // Current labels
            const current = (issue.labels || []).map(l => (l.name || "").toLowerCase());
            const hasDone = current.includes(DONE.toLowerCase());

            // Remove other status:* labels to keep "single status" invariant
            const toRemove = (issue.labels || [])
              .map(l => l.name)
              .filter(name => name && name.toLowerCase().startsWith(STATUS_PREFIX) && name.toLowerCase() !== DONE.toLowerCase());

            for (const name of toRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner, repo, issue_number, name
                });
              } catch (e) {
                // ignore if label already removed or missing
              }
            }

            // Add status:done if not present
            if (!hasDone) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: [DONE]
              });
            }
