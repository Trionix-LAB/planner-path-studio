# Backlog задач (MVP)

Формат:
- Приоритет: `P0` (критично), `P1` (важно), `P2` (желательно)
- Оценка: story points (`SP`)

## P0 (сначала)

1. [x] Mission repository: чтение/запись структуры миссии  
Приоритет: `P0`  
Оценка: `8 SP`  
Описание:
- Реализовать операции create/open/save для:
  - `mission.json`
  - `tracks/*.csv`
  - `routes/routes.geojson`
  - `markers/markers.geojson`
Критерии готовности:
- Созданная миссия открывается повторно без потери данных.
- Форматы соответствуют `docs/mission-format.md`.

2. [x] Проверка совместимости `schema_version`  
Приоритет: `P0`  
Оценка: `3 SP`  
Описание:
- Добавить проверку версии при открытии миссии.
- Если версия новее поддерживаемой, показать явную ошибку и прервать загрузку.
Критерии готовности:
- Нет частичного парсинга миссий с неподдерживаемой версией.

3. [x] `mission.lock` и защита от параллельного открытия  
Приоритет: `P0`  
Оценка: `3 SP`  
Описание:
- Создавать lock при открытии миссии в режиме записи.
- Удалять lock при закрытии миссии/приложения.
- При обнаружении lock показывать предупреждение и отказывать в записи.
Критерии готовности:
- Параллельное редактирование одной миссии предотвращается.

4. [x] Draft autosave + restore  
Приоритет: `P0`  
Оценка: `5 SP`  
Описание:
- Автосохранение черновика в platform storage.
- На `StartScreen` показывать “Восстановить черновик” только при фактическом наличии.
Критерии готовности:
- После перезапуска приложение предлагает восстановление черновика.

5. [x] Интеграция `MapWorkspace` с реальными данными  
Приоритет: `P0`  
Оценка: `5 SP`  
Описание:
- Убрать хардкод миссии/объектов/треков.
- Подключить состояние от repository.
Критерии готовности:
- Экран карты отображает данные текущей миссии/черновика.

6. [x] Debounced autosave миссии + индикатор статуса  
Приоритет: `P0`  
Оценка: `3 SP`  
Описание:
- Автосохранение через 1-2 секунды после изменений.
- Реальные статусы: `saving/saved/error`.
Критерии готовности:
- Индикатор в toolbar отражает реальное состояние.

7. [x] Трек-сессии: pause/resume/finish + `segment_id`  
Приоритет: `P0`  
Оценка: `8 SP`  
Описание:
- `pause/finish` закрывают активный трек (`ended_at`).
- `resume` создает новый трек.
- Потеря связи не закрывает трек; при восстановлении инкремент `segment_id`.
Критерии готовности:
- CSV и метаданные треков соответствуют `docs/spec.md`.

## P1 (после ядра)

8. [x] Route/Zone/Marker: полноценное создание объектов  
Приоритет: `P1`  
Оценка: `5 SP`  
Описание:
- Завершение рисования реально добавляет объект.
- Для marker после клика открывать свойства.
Критерии готовности:
- Созданные объекты сохраняются и видны после reopen.

9. [x] Редактирование геометрии (select mode)  
Приоритет: `P1`  
Оценка: `8 SP`  
Описание:
- Drag вершин, добавление вершины на сегмент, удаление вершины.
Критерии готовности:
- Правки геометрии отражаются сразу и сохраняются.

10. [x] Клавиши `Esc` и `Delete`  
Приоритет: `P1`  
Оценка: `3 SP`  
Описание:
- `Esc`: отмена рисования + возврат в select.
- `Delete`: удаление выделенного объекта.
Критерии готовности:
- Поведение соответствует разделу flow в `docs/screens.md`.

11. [x] Контекстное меню объекта  
Приоритет: `P1`  
Оценка: `5 SP`  
Описание:
- Добавить `Свойства`, `Переименовать`, `Удалить`.
- Для зоны: `Перегенерировать галсы`.
Критерии готовности:
- Все действия доступны через правый клик.

12. Генерация галсов из зоны  
Приоритет: `P1`  
Оценка: `8 SP`  
Описание:
- Генерировать `lane` по `lane_angle_deg` и `lane_width_m`.
- Галсы производные, отдельное редактирование запрещено.
Критерии готовности:
- Изменение параметров зоны меняет набор lanes.

13. Outdated lanes + перегенерация после изменения зоны  
Приоритет: `P1`  
Оценка: `5 SP`  
Описание:
- После изменения геометрии зоны помечать lanes неактуальными.
- Дать действие `Перегенерировать`.
Критерии готовности:
- Перегенерация заменяет старые lanes у родительской зоны.

14. Каскадное удаление зоны и галсов  
Приоритет: `P1`  
Оценка: `3 SP`  
Описание:
- При удалении `survey_area` удалять все дочерние `lane`.
- Показывать подтверждение с количеством галсов.
Критерии готовности:
- Нельзя оставить “висячие” lanes без parent.

15. Настройки: persistence + runtime apply  
Приоритет: `P1`  
Оценка: `8 SP`  
Описание:
- Разделить global defaults и mission overrides.
- Применять настройки к карте без перезапуска.
Критерии готовности:
- Настройки переживают перезапуск, миссионные override пишутся в `mission.json`.

16. Экспорт GPX/KML/CSV (реальный)  
Приоритет: `P1`  
Оценка: `8 SP`  
Описание:
- Реализовать экспорт треков/маршрутов/маркеров.
- Поддержать режимы выборки: активный/выбранные/все.
Критерии готовности:
- Файлы экспорта создаются корректно, включая сегментацию трека.

## P2 (улучшения)

17. Undo/Redo (`Ctrl+Z` / `Ctrl+Y`)  
Приоритет: `P2`  
Оценка: `5 SP`  
Описание:
- История действий для объектов планирования.
Критерии готовности:
- Основные операции создания/редактирования/удаления откатываются.

18. Измерения маршрута (сегменты + total) без моков  
Приоритет: `P2`  
Оценка: `3 SP`  
Описание:
- Пересчет длины маршрута и сегментов, режимы `off/on-select/always`.
Критерии готовности:
- Значения в свойствах и на карте вычисляются из геометрии.

19. Улучшение отображения статуса связи  
Приоритет: `P2`  
Оценка: `2 SP`  
Описание:
- Показывать “Нет данных N сек”, а не только бинарный статус.
Критерии готовности:
- Оператор видит длительность таймаута.

20. Тесты сериализации и smoke e2e сценариев  
Приоритет: `P2`  
Оценка: `5 SP`  
Описание:
- Тесты round-trip для mission/geojson/csv.
- Smoke: create -> edit -> autosave -> reopen -> export.
Критерии готовности:
- Критичные сценарии покрыты автоматическими тестами.
