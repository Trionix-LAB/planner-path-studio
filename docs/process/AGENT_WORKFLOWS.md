Я отвечу как world-famous PhD по software architecture и AI-assisted engineering, лауреат ACM SIGSOFT Distinguished Paper Award.

Для построения надежной системы, где автономные агенты не ломают кодовую базу, а команда не утопает в микроменеджменте, требуется предельно точный контракт. Ниже представлен максимально подробный документ, раскрывающий каждую деталь нашего обновленного процесса, где источником истины является статус Issue.

---

# AI-Assisted Engineering: The Comprehensive Workflow Guide

Этот документ является исчерпывающим руководством по организации процесса разработки с участием автономных агентов. В его основе лежит строгий конечный автомат (FSM), где реальное состояние работы определяется исключительно лейблами на Issue (`status:*`). Процесс гарантирует, что ответ на вопрос «Зачем сделано это изменение?» всегда находится рядом с кодом.

## 1. Архитектура Артефактов

Система опирается на строго заданные форматы файлов, описаний и коммитов.

### 1.1. Единственный источник истины (`spec.md`)

* Вся информация о поведении системы, требованиях и контрактах хранится в единственном файле `spec.md`.
* Каждое требование нумеруется уникальным идентификатором, например, `R-021`.
* Если агент или человек хочет изменить поведение системы, он обязан сначала внести изменения в `spec.md`.

### 1.2. План реализации (`tasks/T-XXXX.md`)

* План фиксируется в репозитории отдельным файлом `tasks/T-XXXX.md`, где `XXXX` — номер связанного Issue.
* План должен быть лаконичным и содержать от 3 до 7 проверяемых чекбоксов.
* Наличие чекбоксов делает план машино- и человекочитаемым.
* Если план подразумевает кодовые изменения, он должен включать шаг добавления или обновления тестов.

### 1.3. Формат Issue

* **Заголовки:** В статусе `backlog` допускаются свободные заголовки или префикс `idea(area): ...`. При переходе в рабочий статус заголовок строго нормализуется: `feat(area): ...`, `fix(area): ...`, `spec(area): ...` или `chore(area): ...`.
* **Тело Issue:** Должно содержать секции: `Spec: R-XXX` (или `New requirement`), `Goal` (ожидаемый результат), `Plan` (ссылка на файл `tasks/T-XXXX.md`) и `Acceptance` (критерии приемки).

### 1.4. Шаблон Pull Request (PR Body)

Каждый рабочий PR, затрагивающий код, обязан включать следующий блок:

* `Fixes #XXXX` (для автоматического связывания).
* `Spec: R-XXX` (ссылка на контракт).
* `Plan: tasks/T-XXXX.md` (ссылка на план).
* `Why: ...` (2–5 строк, объясняющих продуктовую или техническую мотивацию).

### 1.5. Формат коммитов

* Коммиты, меняющие поведение системы, должны начинаться с префикса `R-XXX:`.
* Тело такого коммита должно содержать одну строку `Why:`, чтобы контекст сохранялся при использовании `git blame`.

---

## 2. Конечный автомат (FSM) и Жизненный цикл

Управление процессом сводится к перемещению Issue между четырьмя состояниями. Агенту запрещено брать в работу более 1–2 задач одновременно для сохранения предсказуемости (жесткий WIP-лимит).

### Состояние 1: `status:backlog` (Входящие / Intake)

* **Семантика:** Сырая идея, баг-репорт или черновик, ожидающий уточнения.
* **Допустимые действия:** Обсуждение в комментариях, заполнение тела Issue (Spec, Goal, Acceptance).
* **Запреты:** Агенту категорически запрещено открывать PR.

### Состояние 2: `status:todo` (Планирование и Plan Gate)

* **Семантика:** Задача признана годной к работе, требования ясны. Начинается фаза проектирования решения.
* **Триггер перехода:** Команда переводит Issue из `backlog` в `todo`.
* **Действия агента:** 1. Нормализует заголовок Issue.
2. Создает рабочую ветку.
3. Открывает PR (режим «один PR на задачу»).
4. Делает первый коммит, содержащий **только** `tasks/T-XXXX.md` и, при необходимости, изменения в `spec.md` и `adr/`.
* **Запреты:** На этом этапе строго запрещено вносить изменения в директории `src/` и `tests/`.

### Состояние 3: `status:in-progress` (Реализация)

* **Семантика:** План утвержден (Plan Gate пройден). Разрешена кодовая реализация.
* **Триггеры перехода:** * *Ручной:* Человек перемещает Issue в `in-progress`.
* *Автоматический:* Человек оставляет на PR лейбл `plan:approved` (или пишет комментарий `Plan approved ✅`), что служит сигналом агенту перевести Issue в `in-progress`.


* **Действия агента:** 1. Пишет комментарий в Issue о старте работы над кодом и затрагиваемых файлах.
2. Пишет код и тесты, добавляя коммиты в уже открытый PR.
3. После завершения запрашивает ревью команды.

### Состояние 4: `status:done` (Завершено)

* **Семантика:** Работа выполнена, код находится в `main`.
* **Триггер перехода:** Команда нажимает нативную кнопку Approve в GitHub PR и проводит Merge. Issue закрывается автоматически и получает статус `done`.

---

## 3. Макро-команды агента (Skills)

Агент не должен гадать, какие скрипты вызывать. Весь его арсенал сведен к пяти высокоуровневым операциям:

1. **`capture`**: Принять запрос от пользователя и создать сырое Issue с меткой `status:backlog`.
2. **`prepare`**: Дооформить Issue в `backlog`, заполнив обязательные поля (Goal, Acceptance) на основе диалога, и довести карточку до состояния «готово к approve».
3. **`draft_plan`**: Обнаружить переход в `status:todo`, создать ветку, запушить план в `tasks/T-XXXX.md`, обновить `spec.md` и открыть PR для прохождения Plan Gate.
4. **`execute`**: Обнаружить переход в `status:in-progress` (или триггер `plan:approved`), написать код, добавить тесты в существующий PR и обновить его описание.
5. **`report`**: Сгенерировать сводку по текущему состоянию FSM (какие задачи в `backlog`, `todo`, `in-progress` и какие PR открыты).

---

## 4. Детальные сценарии (Workflows)

В зависимости от типа задачи, поведение агента на разных этапах FSM имеет строгие нюансы.

### 4.1. Разработка фичи (R-XXX существует)

* **Вход:** Требование `R-021` уже есть в `spec.md`.
* **`todo`:** Агент открывает PR и делает коммит исключительно с файлом `tasks/T-XXXX.md`. Код не меняется.
* **`in-progress`:** Агент добавляет в этот же PR коммиты `feat(...)` (реализация) и `test(...)` (интеграционное покрытие).

### 4.2. Разработка фичи БЕЗ спецификации (Spec-first)

* **Вход:** Новая бизнес-логика. В Issue указано `Spec: New requirement`.
* **`todo`:** Агент открывает PR. Первый коммит включает `tasks/T-XXXX.md` и обязательно добавляет новое требование `R-0YY` в `spec.md`. Команда проверяет как план, так и формулировку требования.
* **`in-progress`:** После апрува спецификации реализуется код и тесты, покрывающие новый `R-0YY`.

### 4.3. Баг с нарушением спецификации

* **Вход:** Очевидная ошибка, нарушающая существующий `R-XXX`.
* **`todo`:** Агент создает план `tasks/T-XXXX.md`, в котором обязательным шагом заложено создание регрессионного теста.
* **`in-progress`:** Агент пишет «красный» (падающий) регрессионный тест, затем коммит с фиксом, затем проверяет, что тест позеленел.

### 4.4. Баг БЕЗ спецификации (Узаконивание ожидания)

* **Вход:** Симптом описан, но контракта на это поведение нет. Задача рассматривается не как баг, а как неучтенное требование.
* **`todo`:** Агент готовит PR без кода. Коммит включает `tasks/T-XXXX.md` и добавляет новое/уточненное ожидаемое поведение `R-0YY` в `spec.md`. Команда ревьюит `spec.md`, узаконивая ожидание.
* **`in-progress`:** Пишется регрессионный тест, фикс и возможные `hardening` коммиты для предотвращения аналогичных проблем.

### 4.5. Уточнение спецификации (Spec-only)

* **Вход:** Нужно зафиксировать правила, код менять не нужно.
* **`todo`:** Открывается PR с файлом `tasks/T-XXXX.md` и изменениями в `spec.md` (добавление `R-XXX`).
* **`done`:** Команда ревьюит и сразу делает Merge. Фаза `in-progress` пропускается.

### 4.6. Техдолг или Рефакторинг

* **Вход:** Задача оформлена как чистый `chore(...)`. Изменения в `spec.md` не требуются.
* **`todo`:** Создается `tasks/T-XXXX.md` с планом рефакторинга и проверкой эффекта. В PR обязательна секция `Why:` для сохранения контекста технического решения.
* **`in-progress`:** Агент вносит изменения в инфраструктуру или рефакторит код, доказывая безопасность изменений через тесты.

### 4.7. Архитектурный аудит (Two-phase Workflow)

* **Фаза 1 (Аудит):** Создается задача `chore(area): architecture audit ...`.
* В статусе `todo` агент открывает PR, добавляя только `tasks/T-XXXX.md`, документ с результатами аудита и, при наличии решения, `adr/000X-...md`.
* Изменение `src/` и `tests/` категорически запрещено.
* Команда делает Merge. Фаза `in-progress` не используется.


* **Фаза 2 (Реализация):** На основе результатов аудита создаются новые задачи (`feat/chore`) в `status:backlog`, каждая из которых проходит свой независимый цикл.

### 4.8. Изменение Scope в процессе (Re-plan)

* **Вход:** В фазе `in-progress` выясняется, что текущий план не работает или требования `spec.md` нужно существенно пересмотреть.
* **Действие:** Агент обновляет `tasks/T-XXXX.md` и/или `spec.md` в текущем PR.
* **Возврат (Re-Gate):** Вы или агент возвращаете статус Issue в `todo` (или снимаете маркер `plan:approved` в PR). Написание кода немедленно приостанавливается.
* **Продолжение:** Только после повторного утверждения (возврат в `in-progress`) агент продолжает работу над кодом.

---

## 5. Справочник метаданных (Titles & Labels)

Для обеспечения машиночитаемости и удобства навигации в системе используются строгие соглашения по именованию и маркировке задач.

### 5.1. Формат заголовков (Issue Titles)

Заголовок Issue строится по схеме: `type(area): Short description`.

**Допустимые типы (`type`):**
* `feat`: Новая функциональность или изменение существующего поведения.
* `fix`: Исправление ошибки (бага).
* `spec`: Изменение только документации/спецификации без кода.
* `chore`: Техническое обслуживание, рефакторинг, обновление зависимостей.
* `docs`: Изменение пользовательской или технической документации.
* `idea`: Черновик или предложение (используется только для `status:backlog`).

**Примеры областей (`area`):**
* `agent`: Логика работы автономного агента.
* `memory`: Управление контекстом и долговременной памятью.
* `tools`: Инструментарий и SDK.
* `api`: Интерфейсы взаимодействия.
* `infra`: CI/CD, настройки окружения, Docker.
* `test`: Инфраструктура тестирования.

### 5.2. Список меток (Labels)

Метки определяют состояние задачи в конечном автомате и управляют поведением автоматизаций.

| Метка | Категория | Описание |
| :--- | :--- | :--- |
| `status:backlog` | FSM Status | Входящая задача. Требует уточнения или приоритизации. |
| `status:todo` | FSM Status | Задача готова к работе. Агент может начинать фазу `draft_plan`. |
| `status:in-progress`| FSM Status | План утвержден, идет активная работа над кодом. |
| `status:done` | FSM Status | Задача успешно завершена и влита в `main`. |
| `plan:approved` | PR Gate | Устанавливается на PR. Сигнализирует агенту, что план принят и можно писать код. |
| `priority:high` | Priority | Критичные задачи, требующие немедленного внимания. |
| `type:bug` | Type | Явное указание на ошибку (часто идет вместе с `fix(...)`). |

---

Этот документ описывает замкнутую, детерминированную и безопасную систему работы с ИИ-агентами.