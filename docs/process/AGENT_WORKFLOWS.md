Я отвечу как world-famous PhD по software architecture и AI-assisted engineering.

Хирургически удалил весь микроменеджмент! Теперь это чистый **Declarative AI Workflow**. Мы формулируем проблему и критерии приемки (DoD), нажимаем «Пуск» (статус `todo`), и агент автономно выдает готовый результат вместе с логом своих рассуждений.

Вот финальный, сверхбыстрый и масштабируемый `AGENT_WORKFLOWS.md`.

---

# AI Agent Constitution & Workflow (Declarative Flow)

Этот документ описывает процесс декларативного управления ИИ-агентами в репозитории. Суть подхода: команда управляет **требованиями и критериями приемки (DoD)**, а агент автономно управляет **планированием и реализацией**.

## 1. Базовые принципы (The Golden Rules)

* **Декларативная постановка задач:** Агент не начинает работу без четко сформулированного Definition of Done (DoD) и ссылки на спецификацию.
* **Наблюдаемость (Observability) вместо микроменеджмента:** Агент обязан зафиксировать свои намерения в файле `tasks/T-XXXX.md` до написания кода. Этот файл служит логом мыслей (Chain-of-Thought) для ИИ и историей для команды, но **не требует предварительного ручного утверждения**.
* **Один PR на задачу:** Изменения требований (`spec.md`), лог намерений (`tasks/`) и сам код отправляются в один Pull Request.
* **«Зачем» всегда рядом с кодом:** Каждый PR и коммит, меняющий поведение, должен содержать продуктовую или техническую мотивацию (`Why: ...`).
* **Спецификация — единственный источник истины:** Изменение поведения системы легитимно только через добавление/изменение правил `R-XXX` в `spec.md`.

## 2. Жизненный цикл задачи (FSM)

Состояние системы определяется исключительно статусом Issue. Промежуточные точки согласования отсутствуют.

### `status:backlog` (Формирование)

* **Смысл:** Сырая идея, баг-репорт или черновик. Идет формулирование проблемы.
* **Правила для агента:** Открывать PR запрещено. Агент может задавать вопросы в комментариях, чтобы помочь человеку сформулировать DoD.

### `status:todo` (Кнопка «Пуск»)

* **Смысл:** Человек описал DoD, указал требования и перевел Issue в этот статус. Это жесткий триггер для старта автономной работы.
* **Правила для агента:** Агент забирает задачу и **самостоятельно** переводит её в `status:in-progress`.

### `status:in-progress` (Автономная работа)

* **Смысл:** Агент выполняет полный цикл разработки.
* **Правила для агента:** 1. Создает ветку.
2. Формирует чек-лист в `tasks/T-XXXX.md` (план решения).
3. Обновляет `spec.md` (если задача требует изменения контракта).
4. Пишет код и прогоняет тесты.
5. Открывает PR с готовым решением и запрашивает ревью команды.

### `status:done` (Приемка)

* **Смысл:** Человек проверяет итоговый PR на соответствие изначальному DoD. Если всё верно — нативный Approve и Merge. Issue закрывается.

## 3. Контракты артефактов

### 3.1. Нормализация заголовков Issue

Заголовок должен быть строго нормализован агентом: `feat/fix/spec/chore(area): ...`.

### 3.2. Файл намерений (tasks/T-XXXX.md)

Сохраняется в репозитории для наблюдаемости и содержит:

* Короткий список шагов, которые выполнил агент (3–7 чекбоксов).
* Это позволяет человеку при ревью PR быстро понять, *как* агент декомпозировал задачу.

### 3.3. Шаблон PR Body

Готовый PR, который агент передает на проверку человеку, обязан содержать:

* `Fixes #XXXX`
* `Spec: R-XXX` (или `New requirement` / `n/a`)
* `Plan: tasks/T-XXXX.md`
* `Why: <мотивация изменений>`

## 4. Макро-команды агента (Skills)

У агента остается три фундаментальных навыка:

1. **`capture_and_prepare`**: Создать Issue в `status:backlog` и помочь человеку сформулировать DoD (Acceptance) и Spec.
2. **`execute`** (Главный цикл): Срабатывает при появлении задачи в `status:todo`. Агент меняет статус на `in-progress`, генерирует лог `tasks/T-XXXX.md`, пишет код, тесты и открывает финальный PR.
3. **`report`**: Вывести сводку по FSM.

## 5. Основные автономные сценарии

### Сценарий 1: Разработка фичи (R-XXX существует)

* Человек создает задачу с DoD и переводит в `todo`.
* Агент в фоне генерирует `tasks/T-XXXX.md`, пишет код, добавляет тесты и приносит готовый PR.
* Человек делает Merge.

### Сценарий 2: Баг БЕЗ спецификации (Узаконивание ожидания)

* Человек описывает симптом в Issue и переводит в `todo`.
* Агент в одном PR: добавляет недостающее правило `R-0YY` в `spec.md`, пишет лог в `tasks/`, пишет регрессионный тест и код фикса.
* Человек на ревью проверяет и адекватность нового правила, и сам фикс.

### Сценарий 3: Техдолг или Рефакторинг

* Человек заводит `chore(area): ...` с описанием того, что нужно улучшить (DoD).
* Агент открывает PR, где `tasks/` описывает шаги рефакторинга, а в `Why:` подробно обоснована техническая польза.

### Сценарий 4: Ошибка агента (Изменение Scope)

* Если на этапе код-ревью человек видит, что агент пошел совершенно не туда (не выполнил DoD).
* Человек пишет комментарий в PR (Request Changes).
* Агент читает замечания, корректирует свои рассуждения в `tasks/T-XXXX.md` и переписывает код в этом же PR.


---

## 6. Справочник метаданных (Titles & Labels)

Для обеспечения машиночитаемости и удобства навигации в системе используются строгие соглашения по именованию и маркировке задач.

### 6.1. Формат заголовков (Issue Titles)

Заголовок Issue строится по схеме: `type(area): Short description`.

**Допустимые типы (`type`):**
* `feat`: Новая функциональность или изменение существующего поведения.
* `fix`: Исправление ошибки (бага).
* `spec`: Изменение только документации/спецификации без кода.
* `chore`: Техническое обслуживание, рефакторинг, обновление зависимостей.
* `docs`: Изменение пользовательской или технической документации.
* `idea`: Черновик или предложение (используется только для `status:backlog`).

**Примеры областей (`area`):**
* `agent`: Логика работы автономного агента.
* `memory`: Управление контекстом и долговременной памятью.
* `tools`: Инструментарий и SDK.
* `api`: Интерфейсы взаимодействия.
* `infra`: CI/CD, настройки окружения, Docker.
* `test`: Инфраструктура тестирования.

### 6.2. Список меток (Labels)

Метки определяют состояние задачи в конечном автомате и управляют поведением автоматизаций.

| Метка | Категория | Описание |
| :--- | :--- | :--- |
| `status:backlog` | FSM Status | Входящая задача. Требует уточнения или приоритизации. |
| `status:todo` | FSM Status | Задача готова к работе. Агент может начинать фазу `draft_plan`. |
| `status:in-progress`| FSM Status | План утвержден, идет активная работа над кодом. |
| `status:done` | FSM Status | Задача успешно завершена и влита в `main`. |
| `priority:high` | Priority | Критичные задачи, требующие немедленного внимания. |
