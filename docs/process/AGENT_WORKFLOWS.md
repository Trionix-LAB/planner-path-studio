# AI Agent Constitution & Workflow (DoD-Driven Flow)

Этот документ описывает процесс декларативного управления ИИ-агентами в репозитории. Процесс построен вокруг трех целей: убедиться, что агент понял задачу; убедиться, что он собирается сделать нужное; и доказать, что решение работает.

## 1. Базовые принципы (The Golden Rules)

* **Доказательство понимания через DoD:** Агент доказывает, что понял задачу, формируя понятное описание проблемы и Definition of Done (DoD/Acceptance) до начала кодирования.
* **Наблюдаемость (Observability):** Технический лог действий (`tasks/T-XXXX.md`) не требует предварительного утверждения человеком. Агент использует этот файл для сохранения контекста, чтобы команда понимала, как именно он решал задачу.
* **Доказательство работы через тесты:** Правильность выполнения задачи доказывается агентом через автоматические тесты в итоговом PR.
* **Спецификация как закон:** Изменение ожидаемого поведения системы легитимно только через обновление правил `R-XXX` в файле `spec.md`.
* **Один PR на задачу:** Изменения требований, лог действий и код отправляются строго в один Pull Request.

## 2. Жизненный цикл задачи (FSM)

Управление процессом сводится к перемещению Issue между статусами.

### Фаза 1: Сверка компаса (Issue `status:backlog`)

* **Смысл:** Проверка понимания намерений агента.
* **Действия агента:** На основе запроса человека агент формирует в теле Issue понятное описание фичи/проблемы и список из 2–6 проверяемых критериев DoD (Acceptance). Писать код и открывать PR запрещено.

### Фаза 2: Кнопка «Пуск» (Issue `status:todo`)

* **Смысл:** Человек утвердил DoD. Это жесткий триггер для старта автономной работы.
* **Переход:** Осуществляется только человеком.

### Фаза 3: Автономное исполнение (Issue `status:in-progress`)

* **Смысл:** Агент доказывает правильность работы.
* **Действия агента:** 
  1. Самостоятельно переводит Issue из `todo` в `in-progress`.
  2. Создает ветку и фиксирует свои шаги в логе `tasks/T-XXXX.md`.
  3. Обновляет документы и пишет код/тесты согласно выбранному Use Case.
  4. Открывает финальный PR.

### Фаза 4: Приемка (Issue `status:done`)

* **Смысл:** Код в `main`, задача закрыта.
* **Контроль человека:** Сверка итогового PR с DoD, проверка тестов и нативный Approve. Issue закрывается.

## 3. Контракты артефактов

* **Заголовок Issue:** Строго нормализуется: `feat/fix/spec/chore(area): ...`.
* **Тело Issue:** Понятное описание проблемы, `Spec: R-XXX` (или `New requirement`), `DoD (Acceptance):` (чек-лист).
* **Файл наблюдаемости (`tasks/T-XXXX.md`):** Краткий список выполненных агентом шагов (для ревьюера).
* **PR Body:** `Fixes #XXXX`, `Spec: R-XXX`, `Tasks Log: tasks/T-XXXX.md`, `Why: <мотивация>`.

---

## 4. Use Cases (Основные сценарии)

### 4.1. Новая фича, которой нет в `spec.md` (Spec-first)

Используется, когда нужно добавить новую бизнес-логику, не описанную в контрактах.

* **Issue:** Заголовок `feat(...)`. В теле обязательно указывается `Spec: New requirement`. Человек проверяет сформулированные агентом DoD и нажимает «Пуск» (`status:todo`).
* **Исполнение:** Агент генерирует лог `tasks/T-XXXX.md`, самостоятельно формулирует и добавляет новое правило `R-0YY` в `spec.md`, после чего пишет код и покрывает новое правило тестами.
* **PR:** Содержит лог, изменение спеки, код и тесты.

### 4.2. Имплементация фичи из `spec.md`

Используется, когда требование уже существует, но еще не реализовано в коде.

* **Issue:** Заголовок `feat(...)`. В теле указывается ссылка на существующий контракт (например, `Spec: R-021`).
* **Исполнение:** Агент логирует действия в `tasks/T-XXXX.md`, пишет реализацию и интеграционные тесты строго по R-XXX. `spec.md` не меняется.

### 4.3. Баг (Варианты)

Процесс зависит от того, был ли нарушен существующий контракт.

* **Вариант А: Нарушение существующего контракта**
  * **Issue:** `fix(...)`, `Spec: R-XXX`.
  * **Исполнение:** Агент обязан написать падающий регрессионный тест для R-XXX, затем написать фикс, который заставит тест позеленеть. Шаги логируются в `tasks/`.

* **Вариант Б: Отсутствие контракта (Неоправданное ожидание)**
  * **Контекст:** Есть наблюдаемая проблема, но в `spec.md` нет правила, запрещающего такое поведение.
  * **Issue:** `fix(...)`, `Spec: New requirement`. DoD включает легализацию правильного поведения.
  * **Исполнение:** Агент сначала добавляет новое правило `R-0YY` в `spec.md` (узаконивает ожидание), затем пишет регрессионный тест и фикс.

### 4.4. Исследование / Подготовка требований (Audit / Spec-only)

Используется для архитектурных ревью, аудита или формализации требований, когда результатом должен стать документ, а не код.

* **Issue:** Заголовок `spec(...)` (если это правила) или `chore(area): audit ...` (если это архитектура). DoD явно требует создания документа-артефакта.
* **Исполнение:** Агент проводит исследование, фиксирует ход мыслей в `tasks/T-XXXX.md` и генерирует артефакт: либо файл архитектурного решения (`adr/000X-...md`), либо обновления в `spec.md`.
* **Критическое ограничение:** В этом типе задач агенту **категорически запрещено** изменять файлы в директориях `src/` и `tests/`.
* **PR:** Содержит только текстовые документы и лог.

## 6. Справочник метаданных (Titles & Labels)

Для обеспечения машиночитаемости и удобства навигации в системе используются строгие соглашения по именованию и маркировке задач.

### 6.1. Формат заголовков (Issue Titles)

Заголовок Issue строится по схеме: `type(area): Short description`.

**Допустимые типы (`type`):**
* `feat`: Новая функциональность или изменение существующего поведения.
* `fix`: Исправление ошибки (бага).
* `spec`: Изменение только документации/спецификации без кода.
* `chore`: Техническое обслуживание, рефакторинг, обновление зависимостей.
* `docs`: Изменение пользовательской или технической документации.
* `idea`: Черновик или предложение (используется только для `status:backlog`).

**Примеры областей (`area`):**
* `agent`: Логика работы автономного агента.
* `memory`: Управление контекстом и долговременной памятью.
* `tools`: Инструментарий и SDK.
* `api`: Интерфейсы взаимодействия.
* `infra`: CI/CD, настройки окружения, Docker.
* `test`: Инфраструктура тестирования.

### 6.2. Список меток (Labels)

Метки определяют состояние задачи в конечном автомате и управляют поведением автоматизаций.

| Метка | Категория | Описание |
| :--- | :--- | :--- |
| `status:backlog` | FSM Status | Входящая задача. Требует уточнения или приоритизации. |
| `status:todo` | FSM Status | Задача готова к работе. Агент может начинать. |
| `status:in-progress`| FSM Status | Идет активная работа над кодом. |
| `status:done` | FSM Status | Задача успешно завершена и влита в `main`. |
| `priority:high` | Priority | Критичные задачи, требующие немедленного внимания. |