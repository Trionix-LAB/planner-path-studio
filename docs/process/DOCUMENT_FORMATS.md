# Правила оформления документов: Spec и Task

В рамках агентского workflow (DoD-Driven Flow) ключевую роль играют два типа документов: **Спецификация (`spec.md`)** и **Лог действий (`tasks/T-XXXX.md`)**. Ниже описаны строгие правила их формирования и ведения для обеспечения автономности агентов и прозрачности для команды.

---

## 1. Спецификация (`spec.md`)

`spec.md` — это единственный источник истины о поведении системы. Любое изменение логики, добавление фичи или исправление багов (если баг нарушает ожидаемое поведение) должно опираться на этот документ.

### 1.1. Базовые принципы
* **Декларативность:** Описывает *что* система должна делать, а не *как* она это реализует.
* **Тестируемость:** Каждое требование должно быть сформулировано так, чтобы его можно было однозначно проверить автотестом.
* **Уникальность:** Каждое требование имеет уникальный неизменяемый идентификатор `R-XXX` (где XXX — число).

### 1.2. Формат требования
Требования должны группироваться по доменам/компонентам и следовать формату RFC 2119 (`MUST`, `SHOULD`, `MAY`), описывая конкретный контракт:

```markdown
### [Название компонента или домена]

* **R-XXX:** `[Component]` **MUST** `[Action/Behavior]` **WHEN** `[Condition]`.
  * *Context:* (Опционально) Краткое пояснение, почему это важно.
  * *Example:* (Опционально) Пример входных/выходных данных.
```

**Пример:**
```markdown
### API Export
* **R-021:** `API` **MUST** allow exporting run results as JSON **WHEN** a valid `run_id` is provided.
* **R-022:** `API` **MUST** return `404 Not Found` **WHEN** the requested `run_id` does not exist.
```

### 1.3. Правила обновления `spec.md`
* **Новая фича:** Агент добавляет новое требование `R-XXX` в `spec.md` и фиксирует это в логе (в том же PR).
* **Изменение логики:** Агент обновляет существующее требование `R-XXX` (или помечает старое как `DEPRECATED` и добавляет новое) и описывает причину изменения в PR.
* **Баг без спецификации:** Если найдено нежелательное поведение, не описанное в `spec.md`, агент сначала добавляет новое требование (узаконивает ожидание), а затем пишет код для его выполнения.

---

## 2. Лог действий (tasks/T-XXXX.md)

Файл создается для каждой задачи (Issue) и является логом мыслей агента (Observability). Он фиксирует, *что* и *как* было сделано или планируется.

### 2.1. Базовые принципы
* **Один PR:** Лог создается и дополняется в том же PR, что и код/тесты. Он не требует предварительного апрува.
* **Краткость и проверяемость:** Шаги должны быть конкретными (оптимально 3–7 чекбоксов).
* **Связь с мотивацией:** Лог всегда должен отвечать на вопрос «Зачем мы это делаем?».

### 2.2. Структура файла `T-XXXX.md`

Файл должен строго соответствовать следующему шаблону:

```markdown
# T-XXXX: [Название задачи из Issue]

**Issue:** #[Номер Issue]
**Spec:** [R-XXX | New requirement | N/A (для chore/refactoring)]

## Why (Мотивация)
* [2-3 строки о том, какую бизнес- или техническую ценность несет эта задача. Почему это важно сделать сейчас?]

## Goal (Цель)
* [Краткое описание конечного результата. Что изменится в системе после выполнения задачи?]

## Plan (Шаги реализации)
* [ ] Шаг 1: [Например, обновить `spec.md` и добавить R-0YY]
* [ ] Шаг 2: [Написать падающий тест для проверки R-0YY]
* [ ] Шаг 3: [Реализовать логику в `src/...`]
* [ ] Шаг 4: [Убедиться, что все тесты проходят]
* [ ] Шаг 5: [Обновить документацию/README, если применимо]

## Acceptance (Критерии приемки)
* [ ] [Критерий 1: Например, Endpoint возвращает валидный JSON]
* [ ] [Критерий 2: Интеграционные тесты покрывают happy-path и краевые случаи]
```

### 2.3. Правила составления лога (Tasks Log)
* **Test-First (TDD):** Для фичей и багов лог должен явно включать шаг написания/обновления тестов *до* или *вместе* с реализацией.
* **Без деталей реализации:** Лог не должен содержать большие куски кода. Он описывает намерения (например, "Добавить обработчик GET /export", а не "Написать функцию `function export(req, res) { ... }`").
* **Аудит и Рефакторинг:** Если задача не меняет поведение (`chore`), в логе должно быть явно указано, как агент докажет отсутствие регрессий (например, "Опираться на существующие тесты в `tests/api.spec.ts`").
* **Адаптивность:** Если в процессе реализации (`status:in-progress`) выясняется, что подход нужно существенно изменить, агент обязан обновить `T-XXXX.md` в текущем PR (Re-plan), чтобы ревьюеры понимали ход мыслей.
