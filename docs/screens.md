Спека экранов (MVP)

Документ описывает основные экраны и базовую навигацию MVP модуля карт.

## 0. Общие принципы UI (MVP)

- Платформа: desktop (мышь + клавиатура). Тач-жесты можно поддержать частично, но не являются обязательными.
- Основное рабочее пространство = карта + минимум постоянно видимых элементов (HUD, статус-бар, панель инструментов).
- Все "тяжелые" действия (создание миссии, открытие, экспорт, настройки) доступны из верхнего меню/кнопки "Миссия".
- Обратная связь: при потере связи/паузы записи/ошибках файлов отображается явная, но не мешающая работе индикация.

## 1. Экран: Преконфигурация (стартовое меню)

Назначение: выбрать режим старта - открыть миссию, создать новую, продолжить в черновике, восстановить черновик.

Состав:

- Заголовок: "Карты".
- Основные действия:
  - "Новая миссия"
  - "Открыть миссию"
  - "Черновик"
  - (если есть автосохраненный черновик) "Восстановить черновик"
  - "Оборудование"
- (опционально) блок "Недавние миссии" (список путей) с быстрым открытием.

Переходы:

- "Новая миссия" -> Экран 3 (Создание миссии).
- "Открыть миссию" -> Экран 4 (Открытие миссии).
- "Черновик" -> Экран 2 (Рабочий экран карты) в режиме нового пустого черновика.
  - Предыдущий автосохраненный `draft/current` считается сброшенным.
- "Восстановить черновик" -> Экран 2 (Рабочий экран карты) + восстановленное состояние UI/объектов из `draft/current`.
- "Оборудование" -> Экран 9 (Экран выбора оборудования)

Состояния:

- Если восстановление черновика недоступно (повреждено) - показать сообщение и предложить начать новый черновик.

## 2. Экран: Рабочий экран карты (основной)

Назначение: реальное время (водолаз/база), трек, планирование (маршруты/зоны/галсы/маркеры), управление слоями, миссия/экспорт/настройки.

Лейаут (рекомендуемый):

- Центр: карта (OSM).
- Верхняя панель (toolbar):
  - Блок "Миссия": имя миссии (или "Черновик"), индикатор автосохранения, кнопки "Открыть/Сохранить как.../Экспорт".
  - В меню "Миссия" обязательно есть пункт "На старт" для возврата на стартовый экран (Экран 1).
  - Блок "Инструменты": "Маршрут", "Зона (галсы)", "Маркер", "Выбор/Редактирование".
  - Блок "Трек": "Пауза", "Возобновить", "Завершить трек".
  - Блок "Настройки" (иконка шестерни).
- Правая панель (dock):
  - HUD (координаты, скорость, курс, глубина) — отображает данные выбранного агента (при выборе агента в левой панели HUD переключается на его телеметрию).
  - Статусы: связь (ОК/таймаут), запись трека (идет/пауза — для выбранного агента), активный трек (id/номер).
  - Треки агента: при выбранном агенте показывается список его треков (аналогично прежнему «Треки миссии», но отфильтрованный по `agent_id`). Для каждого трека — время начала/окончания, индикатор активности, кнопка удаления.
  - (опционально) «Объекты» (краткий список: маршруты/зоны/маркеры; быстрый выбор).
  - Свойства объекта.
- Левая панель (dock):
  - Менеджер слоев (track/routes/markers/grid/scale_bar; слой водолаза не отключаемый).
  - Панель «Агенты»: список агентов миссии. Для каждого агента отображается:
    - цветной индикатор (marker_color агента)
    - название (title)
    - индикатор состояния записи трека (пульсирующий при записи / пауза / остановлена)
    - кнопка «Pin» (закрепляет слежение за агентом; активен только один агент)
    - кнопка «Переместиться к» (центрирует карту на агенте)
    - кнопка «Запись/Пауза» (toggle включения/остановки записи трека для этого агента)
    - при клике на агента он становится «выбранным»: HUD в правой панели переключается на его данные, в правой панели появляется список треков этого агента
  - (опционально) «Объекты» (краткий список: маршруты/зоны/маркеры; быстрый выбор).
- Низ: строка состояния
  - Координаты под курсором.
  - Масштаб (если показывается линейка - можно дублировать в статус-баре).

Основные сценарии:

1) Реальное время:
   - метка водолаза (иконка) и метка базовой станции.
  - трек рисуется согласно записи и сегментации (см. [spec/spec.md](../spec/spec.md)).
   - при таймауте связи: визуальная индикация (например, значок/цвет + текст "Нет данных N сек").

2) Режим слежения:
   - кнопка «Pin» в списке агентов (левая панель) включает слежение за выбранным агентом.
   - pin работает только для одного агента: включение на другом автоматически снимает предыдущий.
   - пользовательский pan/drag отключает слежение (pin сбрасывается).

3) Инструменты планирования:
   - "Маршрут": клики добавляют вершины; двойной клик или кнопка "Завершить" завершает.
   - "Зона (галсы)": рисуется Polygon зоны; после завершения - панель параметров (угол 0/90, ширина) и генерация галсов.
   - "Маркер": клик ставит точку и открывает свойства (имя/описание).
   - "Выбор/Редактирование": выбор, перемещение, редактирование вершин, удаление.

4) Свойства объекта:
   - по double-click на объект или через контекстное меню "Свойства" открывается панель/диалог (Экран 7).

5) Возврат на старт:
   - Точка входа: пункт "На старт" в меню "Миссия" (решение по размещению для MVP).
   - Перед переходом выполняется best-effort сохранение текущего состояния миссии/черновика.
   - Для открытой миссии (не draft) освобождается `mission.lock`.
   - Переход выполняется на Экран 1 (`/`), после чего пользователь может выбрать "Черновик", "Восстановить" или открыть миссию.
   - Если состояние автосохранения `error`, перед выходом показывается подтверждение (риск потери последних изменений).

Клавиши (минимум):

- `Esc`: отмена текущего действия/выход из режима рисования.
- `Delete`: удалить выделенный объект.
- `Ctrl+Z` / `Ctrl+Y` (опционально для MVP): undo/redo.

## 3. Экран: Создание миссии

Назначение: создать новую миссию, выбрать папку хранения, задать имя.

Состав:

- Поле "Имя миссии" (обязательное).
- Выбор папки хранения:
  - "Выбрать папку..." (диалог).
  - (опционально) чекбокс "Создать подпапку с именем миссии" (по умолчанию включен).
- Кнопки: "Создать", "Отмена".

Валидация:

- имя не пустое
- папка доступна для записи
- если папка уже содержит `mission.json`:
  - предупреждение и отказ, либо "Открыть существующую" (выбор поведения на усмотрение)

Результат:

- создается структура миссии, `mission.json`
- переход на Экран 2 в режиме миссии (не черновик)

## 4. Экран: Открытие миссии

Назначение: выбрать и открыть существующую миссию.

Состав:

- Выбор папки миссии (диалог).
- (опционально) список "Недавние" + быстрый поиск по имени/пути.
- Индикация статуса:
  - обнаружен `mission.lock` -> предупреждение и отказ от открытия в режиме записи (или предложение read-only, если нужно)
  - версия `schema_version` выше поддерживаемой -> сообщение "требуется обновление"

Результат:

- загрузка объектов/треков
- переход на Экран 2

## 5. Экран: Экспорт

Назначение: экспортировать треки, маршруты, точки в форматы для внешних систем.

Состав:

- Что экспортировать:
  - Треки (выбор: активный трек / выбранные / все)
  - Маршруты и галсы (выбор: выбранные / все)
  - Точки-маркеры (выбор: выбранные / все)
- Формат:
  - Треки: GPX / KML
  - Маршруты: GPX / KML
  - Точки: CSV / GPX
- Путь сохранения (папка + имя файла или авто-имя).
- Кнопки: "Экспорт", "Отмена".

Правила:

- Разрывы по `segment_id` сохраняются как сегменты/раздельные линии (см. [spec/spec.md](../spec/spec.md)).

## 6. Экран: Настройки

Назначение: настроить отображение измерений (сетка/линейка), формат координат, стили объектов, дефолты.

Состав (минимум):

- Блок "Измерения":
  - чекбокс "Линейка масштаба"
  - чекбокс "Сетка (метры)"
  - режим шага сетки: auto / manual + список шагов (если manual)
  - "Длины отрезков": off / on-select / always
<!-- - Блок "Подключение (УКБ)":
  - Выбор профиля: "Старый" / "Новый"
  - Поля (в зависимости от профиля): COM-порт, IP, порты ввода/вывода, скорость ГНСС, координаты базы. -->
- Блок "Координаты":
  - точность вывода (кол-во знаков после запятой; default 6)
- Блок "Стили объектов":
  - трек: цвет, толщина
  - маршрут: цвет, толщина
  - зона: цвет обводки, заливка/прозрачность
  - галсы: цвет, толщина
  - маркеры: иконка (пресеты), режим подписи (hover/always)
  - для каждого агента должна быть возможность назначить источник географических данных на основе выбранного ранее пользователем оборудования в текущем профиле
  - для базовой станции также должен назначаться источник географических данных через тот же механизм, что и для агентов
- Блок "По умолчанию":
  - переключатель темы интерфейса (`Тёмная` / `Светлая`)
    - расположение: `Карта -> Настройки (иконка шестерни) -> вкладка "По умолчанию"`, верхняя часть вкладки
  - follow_diver (default)
  - видимость слоев (track/routes/markers/grid/scale_bar)
- Блок "Агенты":
  - назначение источников навигации для базовой станции и маяков
  - настройки отображения маяков (ID, цвета, размер маркера)
- Блок "Оборудование" (отдельная вкладка):
  - список инстансов оборудования активного профиля с текущим статусом
  - независимое включение/выключение каждого инстанса устройства
  - кнопка перехода на Экран 9 ("Открыть окно оборудования")
- Кнопки: "Применить", "Сбросить по умолчанию", "Закрыть"

Переходы:

- Из вкладки "Оборудование" по кнопке "Открыть окно оборудования" -> Экран 9.
- Возврат с Экранa 9 выполняется обратно в рабочий экран карты с восстановлением контекста (draft/открытая миссия).

Правила хранения:

- Глобальные дефолты: настройки приложения.
- Переопределения для миссии: в `mission.json` (см. [spec/spec.md](../spec/spec.md), `docs/mission-format.md`).

## 7. Экран: Свойства объекта (панель/диалог)

Назначение: редактирование атрибутов и параметров генерации.

Варианты:

1) Маршрут (`route`):
   - имя
   - заметка
   - (опционально) стиль (цвет/толщина) - если поддерживается per-object
   - длина (read-only)
   - (опционально) список сегментов с длиной (read-only)

2) Зона (`survey_area`):
   - имя
   - заметка
   - lane_angle_deg (0/90)
   - lane_width_m
   - (опционально) кнопка "Перегенерировать галсы"

3) Маркер (`marker`):
   - имя
   - описание (многострочно)

Действия:

- "Сохранить" / "Отмена" (если диалог) или auto-save (если панель, согласовать с общим автосохранением миссии).

## 8. Флоу управления объектами на карте (MVP)

Цель: чтобы оператор мог быстро создавать/редактировать объекты без "потери" в режимах и без случайных ломаний галсов.

### 8.1 Общие принципы режимов

- В каждый момент времени активен один инструмент (режим): `Выбор/Редактирование`, `Маршрут`, `Зона (галсы)`, `Маркер`.
- Активный инструмент всегда видим в toolbar (подсветка) и в статус-баре (текст).
- `Esc`:
  - отменяет текущее "рисование" (незавершенную геометрию)
  - возвращает в `Выбор/Редактирование` (если это допустимо по UX)
- Клик по пустой карте в режиме `Выбор/Редактирование` снимает выделение.
- `Delete` удаляет выделенный объект (с подтверждением только для "опасных" операций, см. ниже).

### 8.2 Выбор и контекстные действия (контекстное меню)

Правая кнопка по объекту открывает меню (минимум):

- `Свойства...`
- `Переименовать`
- `Удалить`

Для зоны обследования (`survey_area`) дополнительно:

- `Параметры галсов...` (можно вести в те же "Свойства")
- `Перегенерировать галсы`

### 8.3 Маршрут (LineString)

Создание:

1) Пользователь выбирает инструмент `Маршрут`.
2) Клики по карте добавляют вершины.
3) Завершение: двойной клик по последней точке или кнопка `Завершить` в toolbar.
4) После завершения маршрут получает имя по умолчанию (например `Маршрут 1`) и становится выделенным.
5) Если режим "Длины отрезков" = `on-select`, показываются подписи длины каждого сегмента и общая длина маршрута.

Редактирование (в `Выбор/Редактирование`):

- Перетаскивание вершин.
- Добавление вершины кликом по сегменту (появляется новая вершина).
- Удаление вершины (контекстное меню на вершине или `Delete` при выделенной вершине).

Если включено отображение длин отрезков:

- длины сегментов пересчитываются и обновляются после завершения перемещения (mouse up) или с дебаунсом (например, 200-300 мс)

### 8.4 Маркеры (Point)

Создание:

1) Инструмент `Маркер`.
2) Клик по карте создает точку.
3) Сразу открывается "Свойства" маркера (минимум: имя + описание).

Редактирование:

- Перетаскивание точки.
- Изменение имени/описания в "Свойствах".

### 8.5 Зона обследования + галсы (основной флоу)

#### 8.5.1 Что такое "зона" и что такое "галсы" в UI

- Зона обследования = полигон `survey_area` (master-объект).
- Галсы = набор объектов `lane` (дочерние объекты), всегда привязаны к зоне через `parent_area_id`.
- В UI галсы не считаются "самостоятельными": они производные и пересоздаются из зоны + параметров.

Следствие:

- Редактирование геометрии зоны всегда потенциально меняет галсы.
- Редактирование геометрии отдельных галсов в MVP запрещено (read-only геометрия).

#### 8.5.2 Создание зоны и первичная генерация галсов

1) Пользователь выбирает инструмент `Зона (галсы)`.
2) Клики по карте добавляют вершины полигона.
3) Завершение: двойной клик/кнопка `Завершить`.
4) Сразу после завершения показываем панель "Параметры галсов":
   - `lane_angle_deg`: 0 / 90
   - `lane_width_m`: число (м)
   - кнопка `Сгенерировать` (или авто-генерация при первом открытии панели)
5) После генерации:
   - зона и галсы отображаются на карте
   - зона выделена, галсы подсвечены как "дочерние"
   - в менеджере слоев галсы живут в слое `routes` (как часть "маршруты/галсы")

#### 8.5.3 Выбор зоны и выбор галса

Правило клика (рекомендуемое для MVP):

- Клик по области (по заливке/обводке) выбирает `survey_area`.
- Клик по линии галса выбирает не галс, а его родителя `survey_area` (и дополнительно подсвечивает выбранный галс).

Пояснение: это снижает риск "случайно удалить/изменить" один галс и упрощает работу (в MVP галсы не редактируются по одному).

#### 8.5.4 Изменение параметров галсов (0/90, ширина)

Флоу:

1) Зона выбрана.
2) Пользователь открывает "Свойства" зоны.
3) Меняет `lane_angle_deg` или `lane_width_m`.
4) Перегенерация галсов:
   - вариант A (простой): сразу после изменения (live preview) + debounce.
   - вариант B (безопасный): показываем `Перегенерировать` и применяем только по кнопке.

Для MVP рекомендуется вариант B, чтобы не было неожиданных "скачков" при вводе числа.

#### 8.5.5 Редактирование геометрии зоны (перетаскивание вершин)

Флоу (рекомендуемый для MVP):

1) В `Выбор/Редактирование` пользователь выбирает зону.
2) На вершинах показываются хэндлы (как у маршрута).
3) При перемещении вершины зона меняется.
4) Галсы помечаются как "неактуальные" (визуально: более бледные/штриховка/значок).
5) По завершении drag (mouse up) показываем неинвазивную подсказку:
   - `Галсы неактуальны. [Перегенерировать] [Отложить]`
6) Нажатие `Перегенерировать`:
   - удаляет старые `lane` для `parent_area_id`
   - создает новый набор `lane` с тем же `parent_area_id`

Это дает оператору контроль и уменьшает случайные пересчеты.

#### 8.5.6 Удаление зоны

Удаление зоны (`survey_area`) всегда каскадно удаляет все ее галсы (`lane`).

В UX:

- При `Delete` по зоне показываем подтверждение:
  - "Удалить зону и N галсов? [Удалить] [Отмена]"

Удаление отдельного галса в MVP:

- запрещено (так как галсы производные). В контекстном меню по галсу `Удалить` отсутствует.

#### 8.5.7 Что делать, если нужно "дырка/исключение" в зоне

Для MVP "дырки" (Polygon с holes) не поддерживаем.

Рекомендуемый обходной сценарий:

- рисовать две зоны и генерировать галсы отдельно
- или рисовать более точный контур зоны без внутренних исключений

### 8.6 Порядок галсов и отображение направления

Для MVP (минимум):

- в `lane` есть `lane_index` (1..N), отображение номера опционально.
- направление "змейкой" можно показывать стрелкой на конце каждого галса или только у первого/последнего (опционально).

## 9. Выбор и настройка оборудования

- Слева список профилей оборудования, созданных пользователем. По умолчанию должно быть три профиля
Профиль Zima USBL - включает в себя только оборудование Zima2r
Профиль Zima + GNSS - включает в себя оборудование Zima2r и GNSS-UDP
- Справа различные настройки, которые должны отображаться в том или ином оборудовании (см. [devices.md](device.md))
- Настройки отрисовываются по соответствующей схеме оборудования. (см. [devices.md](device.md))
- Возможность добавить/редактировать/удалить профиль и назначить/редактировать/удалить ему оборудование из списка ([devices.md](device.md))
- Для одного профиля MUST поддерживаться несколько инстансов одного типа устройства (например, несколько `GNSS-UDP`).
- В `Настройки -> Агенты` источники навигации для агентов и базовой станции MUST показывать все инстансы активного профиля.
