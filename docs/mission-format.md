Р¤РѕСЂРјР°С‚ РјРёСЃСЃРёРё (MVP)

Р”РѕРєСѓРјРµРЅС‚ РѕРїРёСЃС‹РІР°РµС‚ СЃС‚СЂСѓРєС‚СѓСЂСѓ РїР°РїРєРё РјРёСЃСЃРёРё, С„РѕСЂРјР°С‚ `mission.json`, РІРЅСѓС‚СЂРµРЅРЅРёРµ С„РѕСЂРјР°С‚С‹ С‚СЂРµРєРѕРІ Рё РѕР±СЉРµРєС‚РѕРІ РїР»Р°РЅРёСЂРѕРІР°РЅРёСЏ.

## 1. РЎС‚СЂСѓРєС‚СѓСЂР° РїР°РїРєРё РјРёСЃСЃРёРё

Р РµРєРѕРјРµРЅРґСѓРµРјР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР°:

- `mission.json` - РјРµС‚Р°РґР°РЅРЅС‹Рµ РјРёСЃСЃРёРё, СЃРїРёСЃРѕРє С‚СЂРµРєРѕРІ, СЃСЃС‹Р»РєРё РЅР° С„Р°Р№Р»С‹ РѕР±СЉРµРєС‚РѕРІ, UI-РЅР°СЃС‚СЂРѕР№РєРё.
- `tracks/` - С‚СЂРµРєРё (CSV).
- `routes/` - РјР°СЂС€СЂСѓС‚С‹, Р·РѕРЅС‹ РѕР±СЃР»РµРґРѕРІР°РЅРёСЏ Рё РіР°Р»СЃС‹ (GeoJSON).
- `markers/` - С‚РѕС‡РєРё-РјР°СЂРєРµСЂС‹ (GeoJSON).
- `exports/` - РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ: СЂРµР·СѓР»СЊС‚Р°С‚С‹ СЌРєСЃРїРѕСЂС‚Р° (GPX/KML/CSV).
- `logs/` - РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ: С„Р°Р№Р»С‹ Р»РѕРіРѕРІ/С‚РµР»РµРјРµС‚СЂРёРё, РµСЃР»Рё РїСЂРёРЅСЏС‚Рѕ С…СЂР°РЅРёС‚СЊ РІРјРµСЃС‚Рµ СЃ РјРёСЃСЃРёРµР№.

## 2. `mission.json`

### 2.1 РћР±С‰РёРµ РїСЂР°РІРёР»Р°

- Р¤РѕСЂРјР°С‚: JSON, РєРѕРґРёСЂРѕРІРєР° UTF-8.
- Р”Р°С‚С‹/РІСЂРµРјСЏ: ISO-8601 UTC СЃ СЃСѓС„С„РёРєСЃРѕРј `Z` (РЅР°РїСЂРёРјРµСЂ `2026-02-03T12:34:56.789Z`).
- Р’РµСЂСЃРёСЏ СЃС…РµРјС‹: `schema_version` (number). Р”Р»СЏ MVP = `1`.

### 2.2 РњРёРЅРёРјР°Р»СЊРЅР°СЏ СЃС…РµРјР° (MVP)

- `schema_version`: number (РЅР°РїСЂРёРјРµСЂ `1`)
- `mission_id`: string (UUID)
- `name`: string
- `created_at`: string (ISO-8601 UTC, `Z`)
- `updated_at`: string (ISO-8601 UTC, `Z`)
- `active_track_id`: string | null (deprecated, СЃРѕС…СЂР°РЅСЏРµС‚СЃСЏ РґР»СЏ РѕР±СЂР°С‚РЅРѕР№ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚Рё; РїСЂРё РЅР°Р»РёС‡РёРё `active_tracks` РёРіРЅРѕСЂРёСЂСѓРµС‚СЃСЏ)
- `active_tracks`: object | null (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ; РєР»СЋС‡ = `agent_uid`, Р·РЅР°С‡РµРЅРёРµ = `track_id` Р°РєС‚РёРІРЅРѕРіРѕ С‚СЂРµРєР° СЌС‚РѕРіРѕ Р°РіРµРЅС‚Р°; `null` РёР»Рё РѕС‚СЃСѓС‚СЃС‚РІРёРµ = РЅРё РѕРґРёРЅ Р°РіРµРЅС‚ РЅРµ Р·Р°РїРёСЃС‹РІР°РµС‚)
- `tracks`: array РѕР±СЉРµРєС‚РѕРІ:
  - `id`: string (UUID)
  - `agent_id`: string | null (uid Р°РіРµРЅС‚Р°, РєРѕС‚РѕСЂРѕРјСѓ РїСЂРёРЅР°РґР»РµР¶РёС‚ С‚СЂРµРє; `null` РґР»СЏ С‚СЂРµРєРѕРІ, СЃРѕР·РґР°РЅРЅС‹С… РґРѕ РІРІРµРґРµРЅРёСЏ РјСѓР»СЊС‚РёР°РіРµРЅС‚РЅРѕР№ Р·Р°РїРёСЃРё)
  - `file`: string (РѕС‚РЅРѕСЃРёС‚РµР»СЊРЅС‹Р№ РїСѓС‚СЊ, РЅР°РїСЂРёРјРµСЂ `tracks/agent1-track-0001.csv`)
  - `started_at`: string (СЃРёСЃС‚РµРјРЅРѕРµ РІСЂРµРјСЏ РЅР°С‡Р°Р»Р° Р·Р°РїРёСЃРё, UTC, `Z`)
  - `ended_at`: string | null (СЃРёСЃС‚РµРјРЅРѕРµ РІСЂРµРјСЏ РѕРєРѕРЅС‡Р°РЅРёСЏ Р·Р°РїРёСЃРё, UTC, `Z`)
  - `note`: string | null
- `files`: object:
  - `routes`: string (РЅР°РїСЂРёРјРµСЂ `routes/routes.geojson`)
  - `markers`: string (РЅР°РїСЂРёРјРµСЂ `markers/markers.geojson`)
- `ui` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ, РЅРѕ СЂРµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ СЃРѕС…СЂР°РЅСЏС‚СЊ):
  - `follow_diver`: boolean
  - `layers`: object (РІРёРґРёРјРѕСЃС‚СЊ СЃР»РѕРµРІ: `track`, `routes`, `markers`, `base_station`, `grid`, `scale_bar`)
  - `coordinates` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): object
    - `precision`: number (РєРѕР»-РІРѕ Р·РЅР°РєРѕРІ РїРѕСЃР»Рµ Р·Р°РїСЏС‚РѕР№ РґР»СЏ lat/lon; default 6)
  - `map_view`: object:
    - `center_lat`: number
    - `center_lon`: number
    - `zoom`: number
  - `measurements` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): object (РЅР°СЃС‚СЂРѕР№РєРё РёР·РјРµСЂРµРЅРёР№/РїРѕРґРїРёСЃРµР№)
    - `grid` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): object
      - `mode`: string (`auto` | `manual`)
      - `step_m`: number (С‚РѕР»СЊРєРѕ РґР»СЏ `manual`)
      - `color`: string (HEX, РЅР°РїСЂРёРјРµСЂ `#64748b`)
      - `width_px`: number (С‚РѕР»С‰РёРЅР° Р»РёРЅРёРё)
      - `line_style`: string (`solid` | `dashed` | `dotted`)
    - `segment_lengths_mode`: string (`off` | `on-select` | `always`)
  - `styles` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): object (РїРµСЂРµРѕРїСЂРµРґРµР»РµРЅРёСЏ РІРЅРµС€РЅРµРіРѕ РІРёРґР° РѕР±СЉРµРєС‚РѕРІ РІ СЂР°РјРєР°С… РјРёСЃСЃРёРё)
    - `track`: object (РЅР°РїСЂРёРјРµСЂ: `{"color":"#00A3FF","width_px":3,"dash":"none"}`)
    - `route`: object
    - `survey_area`: object (РЅР°РїСЂРёРјРµСЂ: `{"stroke_color":"#FF6A00","fill_color":"#FF6A00","fill_opacity":0.15}`)
    - `lane`: object
    - `marker`: object (РЅР°РїСЂРёРјРµСЂ: `{"icon":"pin","label_mode":"hover"}`)
    - `base_station`: object (РЅР°РїСЂРёРјРµСЂ: `{"icon":"base-station","size_px":30}`)
  - `navigation_sources` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): object
    - `agents`: object (РєР»СЋС‡ = `agent_uid`, Р·РЅР°С‡РµРЅРёРµ = `source_id`)
    - `base_station`: string | null (РёРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ РёСЃС‚РѕС‡РЅРёРєР° РіРµРѕРґР°РЅРЅС‹С… РґР»СЏ Р±Р°Р·РѕРІРѕР№ СЃС‚Р°РЅС†РёРё)
  - `base_station` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): object
    - `lat`: number
    - `lon`: number
    - `heading_deg`: number | null
    - `updated_at`: string (ISO-8601 UTC, `Z`)
    - `source_id`: string | null

РџСЂРёРјРµС‡Р°РЅРёСЏ:

- `started_at/ended_at` Р·Р°РґР°СЋС‚СЃСЏ РїРѕ СЃРёСЃС‚РµРјРЅРѕРјСѓ РІСЂРµРјРµРЅРё РїСЂРёР»РѕР¶РµРЅРёСЏ (СЃРѕР±С‹С‚РёСЏ start/stop/pause), Рё РЅРµ РѕР±СЏР·Р°РЅС‹ СЃРѕРІРїР°РґР°С‚СЊ СЃРѕ РІСЂРµРјРµРЅРµРј РїРµСЂРІРѕР№/РїРѕСЃР»РµРґРЅРµР№ С‚РѕС‡РєРё РІ CSV С‚СЂРµРєР°.
- Р’ РјРёСЃСЃРёРё РґР»СЏ РєР°Р¶РґРѕРіРѕ Р°РіРµРЅС‚Р° РјРѕР¶РµС‚ Р±С‹С‚СЊ РЅРµ Р±РѕР»РµРµ РѕРґРЅРѕРіРѕ В«Р°РєС‚РёРІРЅРѕРіРѕВ» С‚СЂРµРєР° (РІ РєРѕС‚РѕСЂС‹Р№ РїРёС€СѓС‚СЃСЏ С‚РѕС‡РєРё). РњР°РїРїРёРЅРі `agent_uid -> track_id` С…СЂР°РЅРёС‚СЃСЏ РІ `active_tracks`. РќРµСЃРєРѕР»СЊРєРѕ Р°РіРµРЅС‚РѕРІ РјРѕРіСѓС‚ Р·Р°РїРёСЃС‹РІР°С‚СЊ С‚СЂРµРєРё РїР°СЂР°Р»Р»РµР»СЊРЅРѕ.
- РџРѕР»Рµ `active_track_id` СЃРѕС…СЂР°РЅСЏРµС‚СЃСЏ РґР»СЏ РѕР±СЂР°С‚РЅРѕР№ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚Рё. РџСЂРё С‡С‚РµРЅРёРё: РµСЃР»Рё `active_tracks` РѕС‚СЃСѓС‚СЃС‚РІСѓРµС‚, Р° `active_track_id` Р·Р°РґР°РЅ, РѕРЅ РёРЅС‚РµСЂРїСЂРµС‚РёСЂСѓРµС‚СЃСЏ РєР°Рє Р°РєС‚РёРІРЅС‹Р№ С‚СЂРµРє РїРµСЂРІРѕРіРѕ (primary) Р°РіРµРЅС‚Р°.
- РџРѕР»Рµ `agent_id` РІ С‚СЂРµРєРµ СѓРєР°Р·С‹РІР°РµС‚, РєР°РєРѕРјСѓ Р°РіРµРЅС‚Сѓ РїСЂРёРЅР°РґР»РµР¶РёС‚ С‚СЂРµРє. РўСЂРµРєРё СЃ `agent_id = null` СЃС‡РёС‚Р°СЋС‚СЃСЏ РїСЂРёРЅР°РґР»РµР¶Р°С‰РёРјРё primary-Р°РіРµРЅС‚Сѓ (РїРµСЂРІРѕРјСѓ РІ РјР°СЃСЃРёРІРµ `ui.divers`).
- РџРѕР»СЏ `ui.navigation_sources` Рё `ui.base_station` СЃС‡РёС‚Р°СЋС‚СЃСЏ РѕРїС†РёРѕРЅР°Р»СЊРЅС‹РјРё РґР»СЏ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚Рё СЃ СѓР¶Рµ СЃРѕС…СЂР°РЅРµРЅРЅС‹РјРё РјРёСЃСЃРёСЏРјРё MVP.

### 2.3 РџСЂРёРјРµСЂ `mission.json`

```json
{
  "schema_version": 1,
  "mission_id": "2feaaeb6-4de8-4a5b-9d2f-0c56b8b034d0",
  "name": "Dive 1",
  "created_at": "2026-02-03T10:00:00.000Z",
  "updated_at": "2026-02-03T10:05:00.000Z",
  "active_track_id": null,
  "active_tracks": {
    "agent-uid-1": "c4caa66d-c9b2-4cc3-a23a-5f9efb405a1c"
  },
  "tracks": [
    {
      "id": "c4caa66d-c9b2-4cc3-a23a-5f9efb405a1c",
      "agent_id": "agent-uid-1",
      "file": "tracks/agent-uid-1-track-0001.csv",
      "started_at": "2026-02-03T10:00:02.000Z",
      "ended_at": null,
      "note": null
    },
    {
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "agent_id": "agent-uid-2",
      "file": "tracks/agent-uid-2-track-0001.csv",
      "started_at": "2026-02-03T10:01:00.000Z",
      "ended_at": "2026-02-03T10:03:30.000Z",
      "note": null
    }
  ],
  "files": {
    "routes": "routes/routes.geojson",
    "markers": "markers/markers.geojson"
  },
  "ui": {
    "follow_diver": true,
    "layers": {
      "track": true,
      "routes": true,
      "markers": true,
      "base_station": true,
      "grid": false,
      "scale_bar": true
    },
    "coordinates": { "precision": 6 },
    "measurements": {
      "grid": { "mode": "auto", "color": "#64748b", "width_px": 1, "line_style": "dashed" },
      "segment_lengths_mode": "on-select"
    },
    "map_view": { "center_lat": 59.93863, "center_lon": 30.31413, "zoom": 14 },
    "navigation_sources": {
      "agents": {
        "agent-1": "zima2r:beacon:1"
      },
      "base_station": "gnss-udp:main"
    },
    "base_station": {
      "lat": 59.93542,
      "lon": 30.33218,
      "heading_deg": 271.2,
      "updated_at": "2026-02-03T10:04:58.000Z",
      "source_id": "gnss-udp:main"
    }
  }
}
```

## 3. РўСЂРµРєРё: `tracks/*.csv`

### 3.1 РћР±С‰РёРµ РїСЂР°РІРёР»Р°

- РљРѕРґРёСЂРѕРІРєР°: UTF-8.
- Р Р°Р·РґРµР»РёС‚РµР»СЊ: Р·Р°РїСЏС‚Р°СЏ `,` (RFC4180-СЃРѕРІРјРµСЃС‚РёРјС‹Р№ CSV).
- Р”РµСЃСЏС‚РёС‡РЅС‹Р№ СЂР°Р·РґРµР»РёС‚РµР»СЊ РІ С‡РёСЃР»Р°С…: С‚РѕС‡РєР° `.`.
- РџРµСЂРІР°СЏ СЃС‚СЂРѕРєР°: Р·Р°РіРѕР»РѕРІРєРё РєРѕР»РѕРЅРѕРє.

### 3.2 РћРґРёРЅ С„Р°Р№Р» = РѕРґРёРЅ С‚СЂРµРє

- РўСЂРµРє = "СЃРµСЃСЃРёСЏ Р·Р°РїРёСЃРё" (РЅР°РїСЂРёРјРµСЂ: РґРѕ/РїРѕСЃР»Рµ РїР°СѓР·С‹, РѕС‚РґРµР»СЊРЅС‹Рµ Р·Р°РїР»С‹РІС‹).
- РџР°СѓР·Р°/Р·Р°РІРµСЂС€РµРЅРёРµ Р·Р°РєСЂС‹РІР°СЋС‚ С‚РµРєСѓС‰РёР№ С‚СЂРµРє Рё СЃС‚Р°РІСЏС‚ `ended_at` РІ `mission.json`.
- РџРѕС‚РµСЂСЏ СЃРІСЏР·Рё РЅРµ Р·Р°РєСЂС‹РІР°РµС‚ С‚СЂРµРє; РІРЅСѓС‚СЂРё С‚СЂРµРєР° СѓРІРµР»РёС‡РёРІР°РµС‚СЃСЏ `segment_id`.

Р РµРєРѕРјРµРЅРґСѓРµРјРѕРµ РёРјСЏ С„Р°Р№Р»Р°: `tracks/<agent_uid>-track-0001.csv`, `tracks/<agent_uid>-track-0002.csv`, ...

РќСѓРјРµСЂР°С†РёСЏ РІРµРґС‘С‚СЃСЏ per-agent (Сѓ РєР°Р¶РґРѕРіРѕ Р°РіРµРЅС‚Р° СЃРІРѕР№ СЃС‡С‘С‚С‡РёРє). Р”Р»СЏ С‚СЂРµРєРѕРІ, СЃРѕР·РґР°РЅРЅС‹С… РґРѕ РІРІРµРґРµРЅРёСЏ РјСѓР»СЊС‚РёР°РіРµРЅС‚РЅРѕР№ Р·Р°РїРёСЃРё (Р±РµР· `agent_id`), РґРѕРїСѓСЃРєР°РµС‚СЃСЏ С„РѕСЂРјР°С‚ `tracks/track-0001.csv`.

### 3.3 РљРѕР»РѕРЅРєРё

РћР±СЏР·Р°С‚РµР»СЊРЅС‹Рµ:

- `timestamp`: ISO-8601 UTC СЃ СЃСѓС„С„РёРєСЃРѕРј `Z`
- `lat`: number (WGS84, РґРµСЃСЏС‚РёС‡РЅС‹Рµ РіСЂР°РґСѓСЃС‹)
- `lon`: number (WGS84, РґРµСЃСЏС‚РёС‡РЅС‹Рµ РіСЂР°РґСѓСЃС‹)
- `segment_id`: integer (РЅР°С‡РёРЅР°РµС‚СЃСЏ СЃ 1; СѓРІРµР»РёС‡РёРІР°РµС‚СЃСЏ РїСЂРё РєР°Р¶РґРѕРј СЂР°Р·СЂС‹РІРµ, РЅР°РїСЂРёРјРµСЂ "СЃРѕРµРґРёРЅРµРЅРёРµ РїРѕС‚РµСЂСЏРЅРѕ -> СЃРѕРµРґРёРЅРµРЅРёРµ РІРѕСЃСЃС‚Р°РЅРѕРІР»РµРЅРѕ")

РћРїС†РёРѕРЅР°Р»СЊРЅС‹Рµ (РµСЃР»Рё РµСЃС‚СЊ):

- `depth_m`: number
- `sog_mps`: number
- `cog_deg`: number (0..360)

РџСЂРёРјРµСЂ СЃС‚СЂРѕРєРё Р·Р°РіРѕР»РѕРІРєРѕРІ:

`timestamp,lat,lon,segment_id,depth_m,sog_mps,cog_deg`

## 4. РћР±СЉРµРєС‚С‹ РїР»Р°РЅРёСЂРѕРІР°РЅРёСЏ Рё РјРµС‚РєРё: GeoJSON

### 4.1 РћР±С‰РёРµ РїСЂР°РІРёР»Р°

- Р¤РѕСЂРјР°С‚: GeoJSON `FeatureCollection`, РєРѕРґРёСЂРѕРІРєР° UTF-8.
- CRS: WGS84.
- РџРѕСЂСЏРґРѕРє РєРѕРѕСЂРґРёРЅР°С‚: `[lon, lat]` (СЃС‚Р°РЅРґР°СЂС‚ GeoJSON).
- РљР°Р¶РґС‹Р№ РѕР±СЉРµРєС‚ С…СЂР°РЅРёС‚СЃСЏ РєР°Рє `Feature`.

РћР±С‰РёРµ СЃРІРѕР№СЃС‚РІР° РґР»СЏ РІСЃРµС… `Feature` (РјРёРЅРёРјСѓРј):

- `id`: string (UUID)
- `kind`: string
- `name`: string
- `note`: string | null
- `created_at`: string (ISO-8601 UTC, `Z`)
- `updated_at`: string (ISO-8601 UTC, `Z`)

### 4.2 `routes/routes.geojson`

РЎРѕРґРµСЂР¶РёС‚ `FeatureCollection` СЃ РѕР±СЉРµРєС‚Р°РјРё СЃР»РµРґСѓСЋС‰РёС… РІРёРґРѕРІ:

1) `kind=route` (СЂСѓС‡РЅРѕР№ РјР°СЂС€СЂСѓС‚)

- `geometry`: `LineString`
- `properties` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ): `style` (РЅР°РїСЂРёРјРµСЂ `{"color":"#FF6A00","width_px":3}`)

2) `kind=survey_area` (Р·РѕРЅР° РѕР±СЃР»РµРґРѕРІР°РЅРёСЏ)

- `geometry`: `Polygon`
- `properties` (РјРёРЅРёРјСѓРј):
  - `lane_angle_deg`: number (0 РёР»Рё 90)
  - `lane_width_m`: number

РџСЂР°РІРёР»Рѕ РґР»СЏ `lane_angle_deg` (MVP):

- `0` = РІРґРѕР»СЊ РіР»Р°РІРЅРѕР№ РѕСЃРё РїРѕР»РёРіРѕРЅР°, `90` = РїРѕРїРµСЂРµРє.
- Р“Р»Р°РІРЅР°СЏ РѕСЃСЊ РїРѕР»РёРіРѕРЅР° РѕРїСЂРµРґРµР»СЏРµС‚СЃСЏ РєР°Рє РЅР°РїСЂР°РІР»РµРЅРёРµ РЅР°РёР±РѕР»СЊС€РµР№ РїСЂРѕС‚СЏР¶РµРЅРЅРѕСЃС‚Рё (С‡РµСЂРµР· РѕСЂРёРµРЅС‚РёСЂРѕРІР°РЅРЅС‹Р№ РѕРіСЂР°РЅРёС‡РёРІР°СЋС‰РёР№ РїСЂСЏРјРѕСѓРіРѕР»СЊРЅРёРє/OBB РёР»Рё СЌРєРІРёРІР°Р»РµРЅС‚РЅС‹Р№ РїСЂРѕСЃС‚РѕР№ РїРѕРґС…РѕРґ РґР»СЏ MVP).

3) `kind=lane` (СЃРіРµРЅРµСЂРёСЂРѕРІР°РЅРЅС‹Р№ РіР°Р»СЃ)

- `geometry`: `LineString`
- `properties` (РјРёРЅРёРјСѓРј):
  - `parent_area_id`: string (UUID Р·РѕРЅС‹ РѕР±СЃР»РµРґРѕРІР°РЅРёСЏ)
  - `lane_index`: integer (1..N)

### 4.3 `markers/markers.geojson`

РЎРѕРґРµСЂР¶РёС‚ `FeatureCollection` СЃ РѕР±СЉРµРєС‚Р°РјРё:

- `kind=marker`
- `geometry`: `Point`
- `properties` (РјРёРЅРёРјСѓРј):
  - `description`: string (РјРЅРѕРіРѕСЃС‚СЂРѕС‡РЅС‹Р№ С‚РµРєСЃС‚)

## 5. Р’РµСЂСЃРёРѕРЅРёСЂРѕРІР°РЅРёРµ Рё СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ

- `schema_version` С…СЂР°РЅРёС‚СЃСЏ РІ `mission.json`.
- Р•СЃР»Рё РїСЂРёР»РѕР¶РµРЅРёРµ РѕС‚РєСЂС‹РІР°РµС‚ РјРёСЃСЃРёСЋ СЃ Р±РѕР»РµРµ РЅРѕРІРѕР№ `schema_version`, РЅСѓР¶РЅРѕ РїРѕРєР°Р·Р°С‚СЊ РїРѕРЅСЏС‚РЅСѓСЋ РѕС€РёР±РєСѓ ("С‚СЂРµР±СѓРµС‚СЃСЏ РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРёР»РѕР¶РµРЅРёСЏ") Рё РЅРµ РїС‹С‚Р°С‚СЊСЃСЏ С‡Р°СЃС‚РёС‡РЅРѕ РёРЅС‚РµСЂРїСЂРµС‚РёСЂРѕРІР°С‚СЊ РґР°РЅРЅС‹Рµ.

## 6. Р—Р°С‰РёС‚Р° РѕС‚ РїР°СЂР°Р»Р»РµР»СЊРЅРѕРіРѕ РѕС‚РєСЂС‹С‚РёСЏ (lock)

Р РµРєРѕРјРµРЅРґСѓРµРјС‹Р№ РјРµС…Р°РЅРёР·Рј:

- РїСЂРё РѕС‚РєСЂС‹С‚РёРё РјРёСЃСЃРёРё СЃРѕР·РґР°РµС‚СЃСЏ С„Р°Р№Р» `mission.lock`
- РїСЂРё Р·Р°РєСЂС‹С‚РёРё РјРёСЃСЃРёРё С„Р°Р№Р» СѓРґР°Р»СЏРµС‚СЃСЏ
- РїСЂРё РѕР±РЅР°СЂСѓР¶РµРЅРёРё `mission.lock` РїСЂРё РѕС‚РєСЂС‹С‚РёРё: РїСЂРµРґСѓРїСЂРµР¶РґРµРЅРёРµ РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ Рё РѕС‚РєР°Р· РѕС‚ РѕС‚РєСЂС‹С‚РёСЏ РІ СЂРµР¶РёРјРµ Р·Р°РїРёСЃРё (РёР»Рё РїСЂРµРґР»РѕР¶РµРЅРёРµ РѕС‚РєСЂС‹С‚СЊ read-only, РµСЃР»Рё СЌС‚Рѕ С‚СЂРµР±СѓРµС‚СЃСЏ)

## 7. Addendum (T-66, 2026-02-28): Durability and Recovery

### 7.1 Дополнительные служебные файлы миссии

- mission.json.bak — резервная копия метаданных миссии, поддерживается рядом с mission.json.
- logs/wal/current.wal — write-ahead snapshot для ускоренного/устойчивого автосохранения.

### 7.2 Порядок записи (checkpoint protocol)

- Запись состояния миссии выполняется в 2 фазы:
  1. staging снапшота в logs/wal/current.wal с flush;
  2. checkpoint в основное хранилище (mission.json.bak -> mission.json -> GeoJSON/CSV), после чего WAL очищается.
- mission.updated_at MUST обновляться при WAL-stage/checkpoint, чтобы можно было выбрать наиболее свежее состояние при recovery.

### 7.3 Порядок чтения (open/recovery)

- При открытии миссии приложение MUST поддерживать fallback:
  - сначала mission.json,
  - затем mission.json.bak, если основной файл отсутствует/пуст/поврежден.
- Если доступен WAL-снапшот, SHOULD выбираться более новое состояние между checkpoint и WAL по mission.updated_at.
- При выборе WAL-состояния приложение SHOULD выполнить self-heal checkpoint (best effort) и восстановить основные файлы миссии.

### 7.4 Lock и некорректное завершение

- mission.lock остается механизмом защиты от параллельной записи.
- Для stale-lock MUST поддерживаться recover-path при открытии, чтобы миссия не оставалась перманентно заблокированной после аварийного завершения.
