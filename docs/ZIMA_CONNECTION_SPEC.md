# Спецификация интеграции с навигационным устройством Zima

Этот документ описывает протокол и логику подключения к навигационному устройству "Zima". Спецификация является технологически-агностичной и предназначена для реализации на любом языке программирования.

## 1. Архитектура подключения
Устройство "Zima" передает навигационные данные по сети.
*   **Тип соединения**: UDP (User Datagram Protocol).
*   **Роль приложения**: Сервер (UDP Listener). Приложение должно открыть UDP-сокет и ожидать входящие пакеты данных.
*   **Сетевые параметры**:
    *   **Порт**: Порт, на который устройство отправляет данные (должен быть конфигурируемым в приложении).
    *   **Адрес**: Приложение слушает на всех интерфейсах (или на конкретном, если требуется), принимая дейтаграммы.

## 2. Формат данных
*   **Протокол**: ASCII-текстовые сообщения по UDP (устройство использует собственный текстовый формат сообщений).
*   **Кодировка**: ASCII.
*   **Структура пакета**: Данные приходят в виде текстовых строк, обычно начинающихся с символа `@` для внутренних сообщений (например, `@AZMLOC`, `@AZMREM`) и заканчиваются переводом строки (`<CR><LF>`).

## 3. Логика обработки данных (Парсинг)

Приложение должно реализовывать следующий алгоритм обработки входящего потока байт:

1.  **Прием**: Чтение данных из UDP-сокета.
2.  **Буферизация/Разделение**: Сборка входящих байт в строки (разделение по символам переноса строки). Игнорирование неполных или битых строк.
3.  **Фильтрация сообщений**:
    *   Анализировать префикс/идентификатор строки (например, `@AZMLOC`, `@AZMREM`) для определения формата и парсера.
    *   При получении `@AZMLOC`/`@AZMREM` извлекать соответствующие поля позиции и телеметрии по описанным в `docs/devices.md` схемам.

4.  **Извлечение полей**:
    *   Для `@AZMLOC` извлекать поля: lat_deg, lon_deg, heading_deg и другие параметры станции (pressure, depth, pitch, roll, speed и т. п.).
    *   Для `@AZMREM` извлекать параметры маяков: rem_addr, SRange_m, Azimuth_deg, Depth_m и т. п. (см. `docs/devices.md`).

5.  **Валидация**:
    *   Проверить, что извлечённые координаты не являются пустыми или нулевыми (`0.0`), так как это часто признак отсутствия фиксации.

5.  **Валидация**:
    *   Проверить, что извлечённые координаты не являются пустыми или нулевыми (`0.0`), так как это часто признак отсутствия фиксации.

## 4. Алгоритм работы

```pseudo
Функция ЗапускСервиса(порт):
    1. Открыть UDP сокет на указанном порту.
    2. Запустить цикл прослушивания:
        а. Если используется входной порт команд, то отправить в него команду OCON
        б. Получить пакет данных (datagram).
        в. Преобразовать байты в строку (ASCII).
        г. Разделить по CR/LF и определить префикс сообщения:
            i. Если префикс == "@AZMLOC": распарсить поля AZMLOC и извлечь lat/lon/heading и др.
            ii. Если префикс == "@AZMREM": распарсить поля AZMREM и обновить данные маяка.
            iii. Иначе: логировать/игнорировать либо применить дополнительный парсер при необходимости.
        д. Если не используется внешний ГНСС, то с помощью команды LHOV отправить в него считанные Широту, долготу и азимут
    3. При остановке сервиса закрыть сокет.
```

## 5. Рекомендации по реализации
*   Для парсинга сообщений Zima (`@AZMLOC`, `@AZMREM`) рекомендуется реализовать или использовать лёгкий текстовый парсер, ориентированный на форматы, описанные в `docs/devices.md`.
*   Обеспечить корректную обработку исключений при сетевых ошибках или некорректном формате данных.

## 6. Команды управления (command channel)
Zima поддерживает простой текстовый канал команд (если настроен command-port). Команды отправляются в виде ASCII-текстов без бинарных обёрток.

- `OCON` — Open CONnections. Открывает/инициирует соединения. Отправляется в command-port.
- `CCON` — Close CONnections. Закрывает все соединения. Отправляется в command-port.
- `LHOV,lat_deg,lon_deg,hdn_deg` — Location and Heading Override. Пример: `LHOV,59.9375,30.3086,120.0`. Отправляется в command-port; lat/ lon в десятичных градусах, hdn — азимут в градусах.

Команды можно отправлять из приложения для тестирования или управления устройством. В реализации `sendCommand(cmd: string)` должен быть базовый guard для безопасной отправки (например, проверка размера строки и логирование ошибок).

## 7. Специфика сообщений `@AZMLOC` и `@AZMREM` (кратко)
 - `@AZMLOC` — локальные параметры станции/антенны. Обычно отправляется ~1 раз в секунду, содержит информацию: давление, глубина, температура, крен/дифферент, возраст данных, lat/lon/course/speed/heading и локальные координаты (x,y,z) и оценку ошибки (rerr).
 - `@AZMREM` — данные маяка-ответчика. Отправляется отдельно для каждого маяка при обновлении или таймауте. Содержит: адрес маяка, наклонную дальность (SRange), азимут прихода, PTime, MSR (уровень сигнала), глубину маяка, проекции, абсолютные азимуты, VCC, температуру, lat/lon (если доступны), сообщение и локальные координаты X/Y/Z, а также признак таймаута.

Полные схемы полей и ограничения значений описаны в `docs/devices.md` (раздел Zima). Реализация сервиса должна опираться на эту спецификацию при разборе и отображении расширенной телеметрии.

## 8. Примеры и тесты
 - Тесты должны покрывать: корректные/обрезанные/битые текстовые строки `@AZMLOC` / `@AZMREM`, случайные/битые пакеты, проигрывание сценариев, а также сценарии отправки команд и проверки реакций (`OCON`/`CCON`/`LHOV`).

## 9. Безопасность и устойчивость
 - Не предполагать, что каждый пакет содержит полное сообщение. Буферизовать байты, разделять по CR/LF и фильтровать неполные строки.
 - Логировать и повышать счетчики ошибок, но не падать на первой же битой строке.

---

См. также: `docs/features/zima-integration.md` и `docs/devices.md` для примеров и конфигурационных значений.
