# feat(integration): Zima navigation device UDP telemetry service

## Описание
Сервис для подключения навигационной системы **Zima** и обработки её UDP-телеметрии. Сервис слушает UDP-пакеты, выделяет текстовые сообщения устройства (например, `@AZMLOC`, `@AZMREM`) и публикует валидные координаты и телеметрию в приложении.

Дополнительно сервис поддерживает базовый command-channel (отправка команд на устройство) для тестирования/управления (например, `OCON`/`CCON`/`LHOV`) — команды отправляются на конфигурируемый "command" порт.

## Основные требования интеграции
- Открыть UDP сокет(ы) и слушать на конфигурируемых портах:
  - Data (выход устройства) — по умолчанию `28127` (конфиг: `zima.dataPort`)
  - Command (вход устройства для команд) — по умолчанию `28128` (конфиг: `zima.commandPort`)
  - Интерфейс: по умолчанию `0.0.0.0` (все интерфейсы) или конкретный адрес (конфиг: `zima.interface`)
 - Парсинг текстовых сообщений Zima (например, `@AZMLOC`, `@AZMREM`) и извлечение полей позиции/телеметрии.
 - Извлечь и корректно преобразовать широту/долготу из полей `@AZMLOC`/`@AZMREM` в десятичные градусы, учитывая знаки и форматы.
 - Валидация координат: игнорировать пустые/нулевые/неконсистентные значения (часто `0.0` означает отсутствующий фикс).
 - Обрабатывать и игнорировать битые или неполные строки безопасно; логировать ошибки сети и парсинга.

## Дополнения из `devices.md` (Zima)
- Поддержка команд:
  - `OCON` — Open CONnections (открыть соединения)
  - `CCON` — Close CONnections (закрыть соединения)
  - `LHOV,lat_deg,lon_deg,hdn_deg` — перегрузка положения/heading (формат: `LHOV,<lat>,<lon>,<heading>`)
  - Формат команд отправляется в текстовом виде в command-port (см. `docs/ZIMA_CONNECTION_SPEC.md` для формата).
 - Сообщения, которые Zima обычно отправляет на data-port: `@AZMLOC` (локальные параметры, обновляется ~1 раз/с) и `@AZMREM` (данные маяка-ответчика). Эти сообщения несут расширенную телеметрию и являются первичным источником данных для сервиса.
 - `@AZMLOC` в актуальной версии протокола может иметь завершающую запятую в конце строки, парсер должен принимать оба варианта.
 - Для `@AZMREM` актуальный хвост: `...,Message,age,IsTimeout,`; в legacy-версии устройства могут встречаться `X_m,Y_m` или `X_m,Y_m,Z_m` перед `IsTimeout`.
 - В реальном UDP-потоке могут встречаться управляющие символы (например, `NUL`) или служебный текст до `@AZM...`; перед разбором строку нужно нормализовать и выделить сообщение от первого `@AZMLOC`/`@AZMREM`.

## Конфигурация
- Источник конфигурации: `AppSettings` / `platform`.
- Переменные/поля конфигурации (рекомендуемые):
  - `zima.enabled: boolean` (по умолчанию: `false`)
  - `zima.dataPort: number` (по умолчанию: `28127`) — порт для приёма данных от Zima
  - `zima.commandPort: number` (по умолчанию: `28128`) — порт для отправки команд в Zima (опционально)
  - `zima.interface: string` (по умолчанию: `0.0.0.0`)
  - `zima.autostart: boolean`

Хранить конфиг в общем хранилище приложения; дополнительно дать возможность настройки через `SettingsDialog`.

## API / Интерфейс
 - События: `zima:position` (payload: `{ lat, lon, time?, heading?, source?: 'AZMLOC'|'AZMREM'|'zima', entity_type, entity_id, navigation_source_id }`).
- Методы: `start()`, `stop()`, `reloadConfig()`, `sendCommand(cmd: string)` (опционально).
- Платформенные точки интеграции: expose via platform API / IPC для Electron и web-абстракции.

## Привязка к агентам и базовой станции
- `@AZMREM` обычно используется как позиция агента/маяка (`entity_type='agent'`, `entity_id` по `rem_addr` и mapping профиля).
- `@AZMLOC` может использоваться как позиция базовой станции (`entity_type='base_station'`) и/или как fallback для heading.
- Назначение источника должно использовать общий механизм выбора источников (как в `docs/screens.md`) и сохраняться в миссии (`docs/mission-format.md`).

## Тестирование
- Unit и integration тесты: симуляция UDP-пакетов (корректные/битые/обрезанные строки `@AZMLOC`/`@AZMREM`, команды).
- В CI можно использовать `tools/zima-sim` (описание в `docs/features/zima-simulator.md`) или аналогичный UDP-генератор.

## Критерии приёмки ✅
- [ ] UDP listener реализован и порты (data/command) конфигурируются
- [ ] Парсинг `@AZMLOC`/`@AZMREM` корректно извлекает координаты и преобразует в decimal degrees
- [ ] Парсер устойчив к актуальному и legacy-вариантам хвоста `@AZMREM` и к завершающей запятой в `@AZMLOC`
- [ ] Невалидные/нулевые координаты отбрасываются
- [ ] Поддержка отправки команд `OCON`, `CCON`, `LHOV` (если command-port включён) — опционально для MVP but documented
- [ ] Учет дополнительных сообщений Zima (`@AZMLOC`, `@AZMREM`) в логике/фильтрации
- [ ] Маршрутизация фиксов в единый telemetry API поддерживает `agent` и `base_station`
- [ ] Наличие unit/integration тестов с ключевыми сценариями
- [ ] Публичный интерфейс для других модулей приложения (`EventEmitter`/platform API)
- [ ] Документация и ссылка на спецификацию добавлены

## Спецификация и справка
Смотреть: `docs/ZIMA_CONNECTION_SPEC.md` и `docs/devices.md`

---

_Теги: integration, telemetry, zima_
