# test(zima): Zima2R simulator (UDP @AZMLOC/@AZMREM) for local and CI testing

## README (short)
- Назначение: CLI-симулятор Zima2R, отправляет UDP сообщения `@AZMLOC` и `@AZMREM` в приложение.
- Быстрый старт: `npm run zima:sim -- --to 127.0.0.1:28127 --rate 1 --beacon-ids 1,2,3`
- Режим playback: `npm run zima:sim -- --mode playback --replay ./scenario.json --to 127.0.0.1:28127`
- Готовый сценарий: `scenario.json` в корне проекта.
- Полезно для проверки: парсинга протокола, привязки `rem_addr` к агентам и поведения при потере/ошибках данных.

## Цель
Лёгкий симулятор базовой станции Zima2R для локального тестирования и CI: UDP-генератор текстовых сообщений Zima (`@AZMLOC`, `@AZMREM`) с поддержкой корректных и некорректных сценариев, а также опциональной имитацией приёма команд (`OCON`, `CCON`, `LHOV`).

## Область и режимы
- CLI/Node скрипт (`tools/zima-sim`) с параметрами: dataPort, commandPort, bindInterface, rate, режим (single, stream, playback, command-echo)
- Форматы сценариев: YAML/JSON с последовательностью Zima-сообщений и задержками (строки начинаются с `@AZMLOC`/`@AZMREM` или произвольным текстом для битых сценариев)
- Режимы отправки: корректные `@AZMLOC`/`@AZMREM`, случайные/битые строки, частично обрезанные пакеты, объединённые несколько сообщений в одном UDP-пакете, проигрывание трасс
- Опционально: Docker image для запуска в CI
- Формат `@AZMLOC` в актуальном протоколе отправляется с завершающей запятой в конце строки.
- Для `@AZMREM` основной формат: `...,Message,age,IsTimeout,`; legacy-совместимость: варианты с `X_m,Y_m` или `X_m,Y_m,Z_m` перед `IsTimeout`.

## Требования
- Конфигурируемые параметры: dataPort (куда симулятор шлёт телеметрию), bindInterface
- Опционально: commandPort — если включён, симулятор может слушать входящие команды и (опционально) отвечать/логировать
- Флаги режима: `--only-valid`, `--only-broken`, `--mix`, `--replay <scenario>`
- CLI API: `start`, `stop`, `load-scenario`, `status`, `send-test-message`
- Примеры сценариев и документация в `docs/` или `tools/`
- Интеграция в тесты репозитория (интеграционные тесты, использующие симулятор)

## Сценарий формата (пример YAML)
```yaml
- msg: "@AZMLOC,1013.2,10.5,12.3,0.1,-0.2,0,59.9375,30.3086,0,0.5,0,120.0,0,"
  delay_ms: 1000
- msg: "@AZMREM,1,123.4,45.0,0.5,30.0,0,10.0,0,123.4,0,50.0,0,30.0,0,12.3,0,10.6,0,13.4,0,59.9376,30.3087,0,200.0,0,Beacon-1,0,False,"
  delay_ms: 500
- msg: "@AZMREM,2,123.4,45.0,0.5,30.0,0,10.0,0,123.4,0,50.0,0,30.0,0,12.3,0,10.7,0,13.6,0,59.9345,30.3087,0,210.0,0,Beacon-2,0,False,"
  delay_ms: 500
```

## Режимы и поведение
- single — отправить одно сообщение и выйти
- stream — генерировать сообщения с указанной частотой (rate)
- playback — проиграть сценарий из файла (YAML/JSON)
- command-echo — слушать commandPort и логировать/ответить на команды (`OCON`, `CCON`, `LHOV`)

## Интерфейс тестирования и интеграции
- Поддержать опцию `--to <host>:<port>` для направления UDP-датаграмм к тестируемому приложению
- В режиме command-echo симулятор слушает `commandPort` и может посылать заранее подготовленный ответ или просто логировать

## Локальный запуск (реализация)
- В репозитории доступен CLI-скрипт: `npm run zima:sim -- --to 127.0.0.1:28127 --rate 1 --command-port 28128 --command-echo true`
- Проигрывание сценария: `npm run zima:sim -- --mode playback --replay ./path/to/scenario.json --to 127.0.0.1:28127`
- Несколько маяков: `npm run zima:sim -- --to 127.0.0.1:28127 --beacon-ids 1,2,3`
- Авто-генерация N маяков: `npm run zima:sim -- --to 127.0.0.1:28127 --beacons 4`

## Критерии приёмки
- [ ] CLI запускается и отправляет Zima-телеметрию (`@AZMLOC`/`@AZMREM`) на указанный порт
- [ ] Наличие сценариев корректного/некорректного потока (YAML/JSON)
- [ ] В режиме `playback` симулятор корректно проигрывает набор сообщений с учётом задержек и объединений
- [ ] Интеграционные тесты в репозитории используют симулятор для проверки парсеров/шлюзов
- [ ] Документация и пример запуска в README

## Связь
Related: #4 (Zima2R integration)

---

_Теги: test, help wanted, enhancement_
